# Jaeger Distributed Tracing Configuration for High-Performance Monitoring

apiVersion: v1
kind: Namespace
metadata:
  name: tracing

---
apiVersion: jaegertracing.io/v1
kind: Jaeger
metadata:
  name: jaeger-prod
  namespace: tracing
spec:
  strategy: production

  storage:
    type: elasticsearch
    options:
      es:
        server-urls: http://elasticsearch.tracing.svc.cluster.local:9200
        index-prefix: jaeger
        use-aliases: true
    esIndexCleaner:
      enabled: true
      numberOfDays: 7
      schedule: "55 23 * * *"

  collector:
    replicas: 5
    maxReplicas: 20
    resources:
      limits:
        cpu: 2000m
        memory: 4Gi
      requests:
        cpu: 500m
        memory: 1Gi
    autoscale: true
    options:
      collector:
        num-workers: 100
        queue-size: 5000

  query:
    replicas: 3
    resources:
      limits:
        cpu: 1000m
        memory: 2Gi
      requests:
        cpu: 200m
        memory: 512Mi
    options:
      query:
        max-clock-skew-adjustment: 5s

  agent:
    strategy: DaemonSet
    options:
      agent:
        tags: "deployment.environment=production"

  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: nginx
      cert-manager.io/cluster-issuer: letsencrypt-prod
    hosts:
      - jaeger.tartware.local
    tls:
      - secretName: jaeger-tls
        hosts:
          - jaeger.tartware.local

---
# OpenTelemetry Collector Configuration for trace aggregation
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config-traces
  namespace: observability
data:
  otel-collector-config.yaml: |
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

      jaeger:
        protocols:
          grpc:
            endpoint: 0.0.0.0:14250
          thrift_http:
            endpoint: 0.0.0.0:14268

    processors:
      # Batch traces for efficiency
      batch:
        timeout: 10s
        send_batch_size: 1024
        send_batch_max_size: 2048

      # Memory limiter to prevent OOM
      memory_limiter:
        check_interval: 1s
        limit_mib: 2048
        spike_limit_mib: 512

      # Probabilistic sampling for high volume
      probabilistic_sampler:
        hash_seed: 22
        sampling_percentage: 10

      # Tail sampling for errors
      tail_sampling:
        decision_wait: 10s
        num_traces: 100
        expected_new_traces_per_sec: 1000
        policies:
          - name: error-policy
            type: status_code
            status_code:
              status_codes:
                - ERROR
          - name: latency-policy
            type: latency
            latency:
              threshold_ms: 1000
          - name: probabilistic-policy
            type: probabilistic
            probabilistic:
              sampling_percentage: 5

      # Resource detection
      resource:
        attributes:
          - key: cloud.provider
            value: kubernetes
            action: insert
          - key: deployment.environment
            value: production
            action: insert

      # Span metrics generation
      spanmetrics:
        metrics_exporter: prometheus
        dimensions:
          - name: http.method
          - name: http.status_code
          - name: service.name

    exporters:
      # Send to Jaeger
      jaeger:
        endpoint: jaeger-prod-collector.tracing.svc.cluster.local:14250
        tls:
          insecure: true

      # Send to Prometheus for span metrics
      prometheus:
        endpoint: "0.0.0.0:8889"

      # Logging for debugging
      logging:
        loglevel: info
        sampling_initial: 5
        sampling_thereafter: 200

    service:
      pipelines:
        traces:
          receivers: [otlp, jaeger]
          processors: [memory_limiter, batch, tail_sampling, spanmetrics, resource]
          exporters: [jaeger, logging]
        metrics:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [prometheus]

      extensions: [health_check, pprof, zpages]
      telemetry:
        logs:
          level: info
        metrics:
          address: :8888

---
# Service for OpenTelemetry Collector
apiVersion: v1
kind: Service
metadata:
  name: otel-collector-traces
  namespace: observability
spec:
  type: ClusterIP
  ports:
    - name: otlp-grpc
      port: 4317
      targetPort: 4317
      protocol: TCP
    - name: otlp-http
      port: 4318
      targetPort: 4318
      protocol: TCP
    - name: jaeger-grpc
      port: 14250
      targetPort: 14250
      protocol: TCP
    - name: jaeger-http
      port: 14268
      targetPort: 14268
      protocol: TCP
    - name: metrics
      port: 8889
      targetPort: 8889
      protocol: TCP
  selector:
    app: otel-collector
