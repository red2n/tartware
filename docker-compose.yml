services:
  postgres:
    image: postgres:16
    container_name: tartware-postgres
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
      # Tartware initialization settings
      TARTWARE_DROP_EXISTING: ${TARTWARE_DROP_EXISTING:-true}
      TARTWARE_RUN_VERIFICATION: ${TARTWARE_RUN_VERIFICATION:-false}
      TARTWARE_BACKUP_BEFORE_DROP: ${TARTWARE_BACKUP_BEFORE_DROP:-false}
    ports:
      - "5432:5432"
    volumes:
      - tartware_postgres_data:/var/lib/postgresql/data
      # Mount all scripts for initialization (read-write for chmod)
      - ./scripts:/docker-entrypoint-initdb.d/scripts
      # Mount custom entrypoint
      - ./scripts/docker/docker-entrypoint-custom.sh:/usr/local/bin/docker-entrypoint-custom.sh
    entrypoint: ["/bin/bash", "/usr/local/bin/docker-entrypoint-custom.sh"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - tartware_network

  redis:
    image: redis:7-alpine
    container_name: tartware-redis
    restart: always
    command: redis-server --requirepass redis_password --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - tartware_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - tartware_network

  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    container_name: tartware-zookeeper
    restart: always
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - tartware_network
    volumes:
      - tartware_zookeeper_data:/bitnami/zookeeper
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.6.1
    container_name: tartware-kafka
    restart: always
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_NUM_PARTITIONS: 12
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "29092:29092"
    networks:
      - tartware_network
    volumes:
      - tartware_kafka_data:/bitnami/kafka
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 10s
      retries: 5

  kafka-init:
    image: confluentinc/cp-kafka:7.6.1
    container_name: tartware-kafka-init
    depends_on:
      kafka:
        condition: service_healthy
    entrypoint: ["/bin/bash", "-c"]
    command: >
      kafka-topics --create --if-not-exists --topic reservations.events --partitions 12 --replication-factor 1 --config retention.ms=604800000 --bootstrap-server kafka:9092;
      kafka-topics --create --if-not-exists --topic reservations.events.dlq --partitions 12 --replication-factor 1 --config retention.ms=1209600000 --config cleanup.policy=delete --bootstrap-server kafka:9092;
      echo "Kafka topics ensured";
    networks:
      - tartware_network
    restart: "no"

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: tartware-kafka-ui
    restart: always
    ports:
      - "8081:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: tartware-local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
      KAFKA_CLUSTERS_1_NAME: tartware-redpanda
      KAFKA_CLUSTERS_1_BOOTSTRAPSERVERS: redpanda:9093
    depends_on:
      kafka:
        condition: service_healthy
      zookeeper:
        condition: service_healthy
    networks:
      - tartware_network

  redpanda:
    image: redpandadata/redpanda:v24.3.1
    container_name: tartware-redpanda
    restart: always
    command:
      - redpanda
      - start
      - --kafka-addr
      - internal://0.0.0.0:9093,external://0.0.0.0:19093
      - --advertise-kafka-addr
      - internal://redpanda:9093,external://localhost:19093
      - --pandaproxy-addr
      - internal://0.0.0.0:8082,external://0.0.0.0:18082
      - --advertise-pandaproxy-addr
      - internal://redpanda:8082,external://localhost:18082
      - --schema-registry-addr
      - internal://0.0.0.0:8083,external://0.0.0.0:18083
      - --rpc-addr
      - redpanda:33145
      - --advertise-rpc-addr
      - redpanda:33145
      - --mode
      - dev-container
      - --smp
      - '1'
      - --default-log-level=info
    ports:
      - "18082:18082"
      - "18083:18083"
      - "19093:19093"
      - "9093:9093"
    volumes:
      - tartware_redpanda_data:/var/lib/redpanda/data
    networks:
      - tartware_network
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  opensearch:
    image: opensearchproject/opensearch:2.13.0
    container_name: tartware-opensearch
    restart: unless-stopped
    environment:
      discovery.type: single-node
      plugins.security.disabled: "true"
      OPENSEARCH_JAVA_OPTS: "-Xms1g -Xmx1g"
      OPENSEARCH_INITIAL_ADMIN_PASSWORD: "Admin123#ChangeMe"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports:
      - "9200:9200"
      - "9600:9600"
    volumes:
      - tartware_opensearch_data:/usr/share/opensearch/data
    networks:
      - tartware_network
    healthcheck:
      test: ["CMD-SHELL", "curl -k -u admin:$$OPENSEARCH_INITIAL_ADMIN_PASSWORD https://localhost:9200/_cluster/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.104.0
    container_name: tartware-otel-collector
    restart: unless-stopped
    command: ["--config=/etc/otel-collector-config.yaml"]
    ports:
      - "4317:4317"
      - "4318:4318"
    volumes:
      - ./docker/otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    depends_on:
      opensearch:
        condition: service_healthy
    networks:
      - tartware_network

volumes:
  tartware_postgres_data:
    name: tartware_postgres_data
    driver: local
  tartware_redis_data:
    name: tartware_redis_data
    driver: local
  tartware_zookeeper_data:
    name: tartware_zookeeper_data
    driver: local
  tartware_kafka_data:
    name: tartware_kafka_data
    driver: local
  tartware_redpanda_data:
    name: tartware_redpanda_data
    driver: local
  tartware_opensearch_data:
    name: tartware_opensearch_data
    driver: local

networks:
  tartware_network:
    name: tartware_network
    driver: bridge
