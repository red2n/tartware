#!/usr/bin/env node

/**
 * Bootstrap load-test environment variables by sampling real IDs from Postgres.
 *
 * Usage:
 *   node scripts/bootstrap-loadtest-env.mjs \
 *     --connection-string=postgres://user:pass@host:5432/tartware \
 *     --env-file=.env.loadtest \
 *     --kustomization=platform/kubernetes/loadtest/kustomization.yaml
 *
 * Environment fallbacks:
 *   PGHOST, PGPORT, PGDATABASE, PGUSER, PGPASSWORD, DATABASE_URL
 */

import { promises as fs } from "node:fs";
import path from "node:path";
import process from "node:process";
import { fileURLToPath } from "node:url";
import { Client } from "pg";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const log = (message) => console.log(`[bootstrap-loadtest] ${message}`);
const warn = (message) => console.warn(`[bootstrap-loadtest][warn] ${message}`);
const fail = (message) => {
	console.error(`[bootstrap-loadtest][error] ${message}`);
	process.exit(1);
};

const DEFAULT_ENV_FILE = ".env.loadtest";
const DEFAULT_KUSTOMIZATION = path.join(
	__dirname,
	"../platform/kubernetes/loadtest/kustomization.yaml",
);

const parseArgs = () => {
	const args = process.argv.slice(2);
	const options = {
		envFile: DEFAULT_ENV_FILE,
		kustomization: DEFAULT_KUSTOMIZATION,
		tenantLimit: Number(process.env.LOADTEST_TENANT_LIMIT ?? "3"),
		sampleLimit: Number(process.env.LOADTEST_SAMPLE_LIMIT ?? "25"),
		gatewayUrl:
			process.env.GATEWAY_BASE_URL ??
			"https://api-gateway.tartware.svc.cluster.local",
	};

	for (const arg of args) {
		if (arg === "--help" || arg === "-h") {
			console.log(`
Usage: node scripts/bootstrap-loadtest-env.mjs [options]

Options:
  --connection-string=URL   Postgres connection string (overrides env)
  --env-file=PATH           Output .env file (default: ${DEFAULT_ENV_FILE})
  --kustomization=PATH      Kustomization YAML to update (default: platform/kubernetes/loadtest/kustomization.yaml)
  --tenant-limit=N          Number of tenants to sample (default: ${options.tenantLimit})
  --sample-limit=N          Number of IDs per list (default: ${options.sampleLimit})
  --gateway-url=URL         Override gateway URL in env output
`);
			process.exit(0);
		} else if (arg.startsWith("--connection-string=")) {
			options.connectionString = arg.split("=")[1];
		} else if (arg.startsWith("--env-file=")) {
			options.envFile = arg.split("=")[1];
		} else if (arg.startsWith("--kustomization=")) {
			options.kustomization = arg.split("=")[1];
		} else if (arg.startsWith("--tenant-limit=")) {
			options.tenantLimit = Number(arg.split("=")[1]);
		} else if (arg.startsWith("--sample-limit=")) {
			options.sampleLimit = Number(arg.split("=")[1]);
		} else if (arg.startsWith("--gateway-url=")) {
			options.gatewayUrl = arg.split("=")[1];
		} else {
			fail(`Unknown argument: ${arg}`);
		}
	}

	return options;
};

const buildClientConfig = (options) => {
	if (options.connectionString || process.env.DATABASE_URL) {
		return {
			connectionString:
				options.connectionString ?? process.env.DATABASE_URL ?? undefined,
		};
	}

	return {
		host: process.env.PGHOST ?? "localhost",
		port: Number(process.env.PGPORT ?? "5432"),
		database: process.env.PGDATABASE ?? "tartware",
		user: process.env.PGUSER ?? "postgres",
		password: process.env.PGPASSWORD ?? "postgres",
		ssl: process.env.PGSSL === "true" ? { rejectUnauthorized: false } : undefined,
	};
};

const ensureValues = (label, values) => {
	if (!values.length) {
		fail(`No ${label} records found. Ensure the database is seeded before running this script.`);
	}
};

const fetchIds = async (client, sql, params = []) => {
	const { rows } = await client.query(sql, params);
	return rows
		.map((row) => row.id)
		.filter((value) => typeof value === "string" && value.length > 0);
};

const resolvePath = (inputPath) =>
	path.isAbsolute(inputPath) ? inputPath : path.resolve(process.cwd(), inputPath);

const writeEnvFile = async (filePath, data, gatewayUrl) => {
	const lines = [
		`# Generated by scripts/bootstrap-loadtest-env.mjs on ${new Date().toISOString()}`,
		`# Update API_TOKEN manually or via kubectl secret`,
		`GATEWAY_BASE_URL=${gatewayUrl}`,
		`TENANT_IDS=${data.tenants.join(",")}`,
		`PROPERTY_IDS=${data.properties.join(",")}`,
		`ROOM_TYPE_IDS=${data.roomTypes.join(",")}`,
		`RESERVATION_IDS=${data.reservations.join(",")}`,
		`GUEST_IDS=${data.guests.join(",")}`,
		`HOUSEKEEPING_TASK_IDS=${data.housekeepingTasks.join(",")}`,
		`HOUSEKEEPING_STAFF_IDS=${data.housekeepingStaff.join(",")}`,
		"",
	].join("\n");

	await fs.writeFile(filePath, lines, "utf8");
	log(`Wrote load-test env values to ${filePath}`);
};

const updateKustomization = async (filePath, data) => {
	const targetPath = resolvePath(filePath);
	try {
		const content = await fs.readFile(targetPath, "utf8");
		const replacements = new Map([
			["TENANT_IDS", data.tenants.join(",")],
			["PROPERTY_IDS", data.properties.join(",")],
			["ROOM_TYPE_IDS", data.roomTypes.join(",")],
			["RESERVATION_IDS", data.reservations.join(",")],
			["GUEST_IDS", data.guests.join(",")],
			["HOUSEKEEPING_TASK_IDS", data.housekeepingTasks.join(",")],
			["HOUSEKEEPING_STAFF_IDS", data.housekeepingStaff.join(",")],
		]);

		let nextContent = content;
		for (const [key, value] of replacements.entries()) {
			const regex = new RegExp(`(-\\s+${key}=).*`, "i");
			if (regex.test(nextContent)) {
				nextContent = nextContent.replace(regex, `$1${value}`);
			} else {
				warn(`Literal ${key} not found in ${filePath}; skipping update for this key.`);
			}
		}

		if (nextContent !== content) {
			await fs.writeFile(targetPath, nextContent, "utf8");
			log(`Updated ${filePath} with sampled UUID lists.`);
		}
	} catch (error) {
		warn(`Unable to update ${filePath}: ${error.message}`);
	}
};

const summarize = (data) => {
	log("Sampled dataset:");
	for (const [key, values] of Object.entries(data)) {
		log(`  ${key}: ${values.length} ids`);
		if (values.length) {
			log(`    ${values.slice(0, 5).join(", ")}${values.length > 5 ? ", ..." : ""}`);
		}
	}
};

const main = async () => {
	const options = parseArgs();
	const clientConfig = buildClientConfig(options);

	const client = new Client(clientConfig);
	try {
		await client.connect();
	} catch (error) {
		fail(`Cannot connect to Postgres: ${error.message}`);
	}

	log("Connected to Postgres. Sampling IDs for load testing...");

	try {
		const tenants = await fetchIds(
			client,
			`SELECT id FROM tenants WHERE COALESCE(is_deleted, FALSE) = FALSE ORDER BY created_at DESC LIMIT $1`,
			[options.tenantLimit],
		);
		ensureValues("tenant", tenants);

		const sampleLimit = options.sampleLimit;
		const scopedQuery = (sql) => fetchIds(client, sql, [tenants, sampleLimit]);

		const properties = await scopedQuery(
			`SELECT id FROM properties WHERE tenant_id = ANY($1::uuid[]) ORDER BY created_at DESC LIMIT $2`,
		);
		ensureValues("property", properties);

		const roomTypes = await scopedQuery(
			`SELECT id FROM room_types WHERE tenant_id = ANY($1::uuid[]) ORDER BY created_at DESC LIMIT $2`,
		);
		ensureValues("room_type", roomTypes);

		const reservations = await scopedQuery(
			`SELECT id FROM reservations WHERE tenant_id = ANY($1::uuid[]) ORDER BY created_at DESC LIMIT $2`,
		);
		ensureValues("reservation", reservations);

		const guests = await scopedQuery(
			`SELECT id FROM guests WHERE tenant_id = ANY($1::uuid[]) ORDER BY created_at DESC LIMIT $2`,
		);
		ensureValues("guest", guests);

		const housekeepingTasks = await scopedQuery(
			`SELECT id FROM housekeeping_tasks WHERE tenant_id = ANY($1::uuid[]) ORDER BY scheduled_date DESC NULLS LAST LIMIT $2`,
		);
		ensureValues("housekeeping task", housekeepingTasks);

		let housekeepingStaff = await scopedQuery(
			`SELECT DISTINCT assigned_to AS id FROM housekeeping_tasks WHERE tenant_id = ANY($1::uuid[]) AND assigned_to IS NOT NULL LIMIT $2`,
		);

		if (!housekeepingStaff.length) {
			warn("No housekeeping staff assignments found. Falling back to tenant staff roles.");
			housekeepingStaff = await scopedQuery(
				`SELECT DISTINCT uta.user_id AS id
         FROM user_tenant_associations uta
         WHERE uta.tenant_id = ANY($1::uuid[])
           AND uta.role IN ('STAFF', 'MANAGER', 'ADMIN')
         LIMIT $2`,
			);
			ensureValues("housekeeping staff fallback", housekeepingStaff);
		}

		const data = {
			tenants,
			properties,
			roomTypes,
			reservations,
			guests,
			housekeepingTasks,
			housekeepingStaff,
		};

		const envFilePath = resolvePath(options.envFile);
		await writeEnvFile(envFilePath, data, options.gatewayUrl);
		await updateKustomization(options.kustomization, data);
		summarize(data);
		log("Next: update tartware-k6-secret with API token, then apply the load-test kustomization.");
	} catch (error) {
		fail(error.message);
	} finally {
		await client.end().catch(() => {});
	}
};

main().catch((error) => fail(error.message));
