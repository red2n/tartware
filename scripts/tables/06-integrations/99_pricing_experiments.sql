-- =============================================
-- Pricing Experiments (A/B Testing)
-- =============================================

CREATE TABLE IF NOT EXISTS pricing_experiments (
    -- Primary Key
    experiment_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,

    -- Multi-tenancy
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    property_id UUID NOT NULL REFERENCES properties(id) ON DELETE CASCADE,

    -- Experiment Details
    experiment_name VARCHAR(255) NOT NULL,
    experiment_description TEXT,
    hypothesis TEXT,

    -- Variants
    control_strategy VARCHAR(255) NOT NULL,
    test_strategy VARCHAR(255) NOT NULL,

    control_rule_id UUID REFERENCES dynamic_pricing_rules_ml(rule_id),
    test_rule_id UUID REFERENCES dynamic_pricing_rules_ml(rule_id),

    -- Traffic Split
    traffic_split_percentage DECIMAL(5,2) DEFAULT 50.00, -- % to test variant

    -- Date Range
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,

    -- Results
    control_bookings INTEGER DEFAULT 0,
    test_bookings INTEGER DEFAULT 0,

    control_revenue DECIMAL(12,2) DEFAULT 0.00,
    test_revenue DECIMAL(12,2) DEFAULT 0.00,

    control_avg_rate DECIMAL(10,2),
    test_avg_rate DECIMAL(10,2),

    control_occupancy DECIMAL(5,2),
    test_occupancy DECIMAL(5,2),

    -- Statistical Significance
    statistical_significance DECIMAL(5,2), -- p-value
    confidence_level DECIMAL(5,2),
    winner VARCHAR(50) CHECK (winner IN ('control', 'test', 'inconclusive', 'ongoing')),

    -- Status
    status VARCHAR(50) DEFAULT 'draft' CHECK (status IN (
        'draft',
        'running',
        'paused',
        'completed',
        'cancelled'
    )),

    -- Notes
    notes TEXT,
    conclusion TEXT,

    -- Audit
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by UUID REFERENCES users(id),
    updated_at TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_by UUID REFERENCES users(id)
);

COMMENT ON TABLE pricing_experiments IS 'A/B testing framework for comparing pricing strategies';
COMMENT ON COLUMN pricing_experiments.experiment_id IS 'Unique identifier for the pricing experiment';
COMMENT ON COLUMN pricing_experiments.tenant_id IS 'Tenant running this experiment';
COMMENT ON COLUMN pricing_experiments.property_id IS 'Property where the experiment is conducted';
COMMENT ON COLUMN pricing_experiments.experiment_name IS 'Human-readable name of the experiment';
COMMENT ON COLUMN pricing_experiments.hypothesis IS 'Business hypothesis being tested by this experiment';
COMMENT ON COLUMN pricing_experiments.control_strategy IS 'Description of the control (baseline) pricing strategy';
COMMENT ON COLUMN pricing_experiments.test_strategy IS 'Description of the test (challenger) pricing strategy';
COMMENT ON COLUMN pricing_experiments.control_rule_id IS 'Dynamic pricing rule used for the control variant';
COMMENT ON COLUMN pricing_experiments.test_rule_id IS 'Dynamic pricing rule used for the test variant';
COMMENT ON COLUMN pricing_experiments.traffic_split_percentage IS 'Percentage of traffic routed to the test variant';
COMMENT ON COLUMN pricing_experiments.start_date IS 'Date when the experiment begins';
COMMENT ON COLUMN pricing_experiments.end_date IS 'Date when the experiment ends';
COMMENT ON COLUMN pricing_experiments.control_bookings IS 'Number of bookings in the control group';
COMMENT ON COLUMN pricing_experiments.test_bookings IS 'Number of bookings in the test group';
COMMENT ON COLUMN pricing_experiments.control_revenue IS 'Total revenue generated by the control group';
COMMENT ON COLUMN pricing_experiments.test_revenue IS 'Total revenue generated by the test group';
COMMENT ON COLUMN pricing_experiments.control_avg_rate IS 'Average nightly rate in the control group';
COMMENT ON COLUMN pricing_experiments.test_avg_rate IS 'Average nightly rate in the test group';
COMMENT ON COLUMN pricing_experiments.control_occupancy IS 'Occupancy rate achieved by the control group';
COMMENT ON COLUMN pricing_experiments.test_occupancy IS 'Occupancy rate achieved by the test group';
COMMENT ON COLUMN pricing_experiments.statistical_significance IS 'P-value indicating statistical significance of results';
COMMENT ON COLUMN pricing_experiments.confidence_level IS 'Confidence level of the experiment results';
COMMENT ON COLUMN pricing_experiments.winner IS 'Declared winner of the experiment (control, test, inconclusive, ongoing)';
COMMENT ON COLUMN pricing_experiments.status IS 'Current status of the experiment (draft, running, paused, completed, cancelled)';
COMMENT ON COLUMN pricing_experiments.conclusion IS 'Summary conclusion drawn from the experiment results';

\echo 'pricing_experiments table created successfully!'
