<section class="admin-container">
  <header class="admin-header">
    <div>
      <p class="eyebrow">Platform Security</p>
      <h1>System Administration Console</h1>
      <p>
        Authenticate with a super-admin account to monitor tenants, review accounts, and issue
        just-in-time impersonation tokens.
      </p>
    </div>
  </header>

  <form class="card login-form" [formGroup]="loginForm" (ngSubmit)="handleLogin()">
    <div class="form-grid">
      <label class="form-control">
        <span>Username</span>
        <input id="username" type="text" formControlName="username" autocomplete="username" />
      </label>

      <label class="form-control">
        <span>Password</span>
        <input
          id="password"
          type="password"
          formControlName="password"
          autocomplete="current-password"
          />
      </label>

      <label class="form-control">
        <span>MFA Code (TOTP)</span>
        <input
          id="mfa_code"
          type="text"
          inputmode="numeric"
          maxlength="6"
          placeholder="123456"
          formControlName="mfa_code"
          />
        <small>Required if MFA is enabled on the admin account.</small>
      </label>

      <div class="form-control fingerprint">
        <span>Device Fingerprint</span>
        <code>{{ deviceFingerprint() }}</code>
        <small>This identifier binds the admin session to this workstation.</small>
      </div>
    </div>

    <div class="actions">
      <button type="submit" class="primary" [disabled]="loginLoading()">
        {{ loginLoading() ? 'Authenticating…' : 'Authenticate' }}
      </button>
      <button type="button" class="ghost" (click)="logout()" [disabled]="!session()">
        Logout
      </button>
    </div>
  </form>

  @if (loginError()) {
    <p class="alert error">{{ loginError() }}</p>
  }

  @if (session(); as activeSession) {
    <section class="card session-summary">
      <div>
        <h2>Session Established</h2>
        <p>
          Signed in as <strong>{{ activeSession.admin.username }}</strong> · Role:
          {{ activeSession.admin.role }}
        </p>
        <p class="meta">
          Session ID: <code>{{ activeSession.session_id }}</code> · Token TTL:
          {{ activeSession.expires_in }}s
        </p>
      </div>
      <div class="summary-actions">
        <button type="button" (click)="loadTenants()" [disabled]="tenantsLoading()">Refresh Tenants</button>
        <button type="button" (click)="loadUsers()" [disabled]="usersLoading()">Refresh Users</button>
      </div>
    </section>
  }

  @if (session()) {
    <section class="data-grid">
      <article class="card data-card">
        <header>
          <div>
            <h3>Tenant Overview</h3>
            <p>Cross-tenant visibility with per-tenant activity signals.</p>
          </div>
          <button type="button" (click)="loadTenants()" [disabled]="tenantsLoading()">Refresh</button>
        </header>
        @if (tenantsError()) {
          <p class="alert error">{{ tenantsError() }}</p>
        }
        @if (tenants().length > 0) {
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Status</th>
                  <th>Users</th>
                  <th>Properties</th>
                  <th>Active Properties</th>
                  <th>Created</th>
                </tr>
              </thead>
              <tbody>
                @for (tenant of tenants(); track trackTenant($index, tenant)) {
                  <tr>
                    <td>
                      <div class="user-cell">
                        <span class="name">{{ tenant.name }}</span>
                        <span class="meta">{{ tenant.slug }}</span>
                      </div>
                    </td>
                    <td>
                      <span class="badge" [class.active]="tenant.status === 'ACTIVE'">
                        {{ tenant.status }}
                      </span>
                    </td>
                    <td>{{ tenant.user_count | number }}</td>
                    <td>{{ tenant.property_count | number }}</td>
                    <td>{{ tenant.active_properties | number }}</td>
                    <td>{{ tenant.created_at | date: 'mediumDate' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        } @else {
          <p class="empty-state">
            {{ tenantsLoading() ? 'Loading tenants…' : 'No tenants were returned.' }}
          </p>
        }
      </article>
      <article class="card data-card">
        <header>
          <div>
            <h3>Platform Users</h3>
            <p>Filter by tenant and initiate impersonation for least-privilege support.</p>
          </div>
          <button type="button" (click)="loadUsers()" [disabled]="usersLoading()">Refresh</button>
        </header>
        <form class="inline-form" [formGroup]="userFilterForm" (ngSubmit)="loadUsers()">
          <label>
            <span>Record Limit</span>
            <input type="number" formControlName="limit" min="1" max="500" />
          </label>
          <label>
            <span>Tenant ID (optional)</span>
            <input type="text" formControlName="tenant_id" placeholder="UUID" />
          </label>
          <button type="submit" class="primary" [disabled]="usersLoading()">Apply Filters</button>
        </form>
        @if (usersError()) {
          <p class="alert error">{{ usersError() }}</p>
        }
        @if (users().length > 0) {
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>User</th>
                  <th>Status</th>
                  <th>Last Login</th>
                  <th>Memberships</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                @for (user of users(); track trackUser($index, user)) {
                  <tr>
                    <td>
                      <div class="user-cell">
                        <span class="name">{{ user.first_name }} {{ user.last_name }}</span>
                        <span class="meta">{{ user.username }} · {{ user.email }}</span>
                      </div>
                    </td>
                    <td>
                      <span class="badge" [class.active]="user.is_active">
                        {{ user.is_active ? 'Active' : 'Inactive' }}
                      </span>
                    </td>
                    <td>{{ user.last_login_at ? (user.last_login_at | date: 'short') : 'Never' }}</td>
                    <td>
                      @if (user.tenants?.length) {
                        <ul class="tenants">
                          @for (membership of user.tenants; track trackMembership($index, membership)) {
                            <li>
                              <strong>{{ membership.tenant_name || membership.tenant_id }}</strong>
                              <span>{{ membership.role }}</span>
                            </li>
                          }
                        </ul>
                      } @else {
                        <span class="empty-state">No tenant assignments</span>
                      }
                    </td>
                    <td>
                      <button type="button" class="ghost" (click)="prefillImpersonation(user)">
                        Prefill Impersonation
                      </button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        } @else {
          <p class="empty-state">
            {{ usersLoading() ? 'Loading users…' : 'No users to display. Adjust filters and retry.' }}
          </p>
        }
      </article>
    </section>
  }

  @if (session()) {
    <section class="card impersonation-card">
      <header>
        <div>
          <h2>Impersonation Controls</h2>
          <p>Every request is recorded in the audit ledger and expires automatically.</p>
        </div>
      </header>
      <form class="impersonation-form" [formGroup]="impersonationForm" (ngSubmit)="startImpersonation()">
        <label>
          <span>Tenant ID</span>
          <input type="text" formControlName="tenant_id" placeholder="Tenant UUID" />
        </label>
        <label>
          <span>User ID</span>
          <input type="text" formControlName="user_id" placeholder="User UUID" />
        </label>
        <label>
          <span>Reason</span>
          <input type="text" formControlName="reason" placeholder="e.g. Investigating incident SEC-42" />
        </label>
        <label>
          <span>Ticket ID</span>
          <input type="text" formControlName="ticket_id" placeholder="SEC-0000" />
        </label>
        <div class="actions">
          <button type="submit" class="primary" [disabled]="impersonationLoading()">
            {{ impersonationLoading() ? 'Issuing Token…' : 'Generate Impersonation Token' }}
          </button>
        </div>
      </form>
      @if (impersonationError()) {
        <p class="alert error">{{ impersonationError() }}</p>
      }
      @if (impersonationToken(); as token) {
        <section class="token-preview">
          <header>
            <strong>Issued Access Token</strong>
            <span>Scope: {{ token.scope }} · TTL: {{ token.expires_in }}s</span>
          </header>
          <textarea readonly>{{ token.access_token }}</textarea>
          <div class="token-actions">
            <button type="button" class="ghost" (click)="copyToClipboard(token.access_token)">
              Copy Token
            </button>
          </div>
        </section>
      }
    </section>
  }
</section>
