<section class="admin-container">
  <header class="admin-header">
    <div>
      <p class="eyebrow">Platform Security</p>
      <h1>System Administration Console</h1>
      <p>
        Authenticate with a super-admin account to monitor tenants, review accounts, and issue
        just-in-time impersonation tokens.
      </p>
    </div>
  </header>

  <form class="card login-form" [formGroup]="loginForm" (ngSubmit)="handleLogin()">
    <div class="form-grid">
      <label class="form-control">
        <span>Username</span>
        <input id="username" type="text" formControlName="username" autocomplete="username" />
      </label>

      <label class="form-control">
        <span>Password</span>
        <input
          id="password"
          type="password"
          formControlName="password"
          autocomplete="current-password"
        />
      </label>

      <label class="form-control">
        <span>MFA Code (TOTP)</span>
        <input
          id="mfa_code"
          type="text"
          inputmode="numeric"
          maxlength="6"
          placeholder="123456"
          formControlName="mfa_code"
        />
        <small>Required if MFA is enabled on the admin account.</small>
      </label>

      <div class="form-control fingerprint">
        <span>Device Fingerprint</span>
        <code>{{ deviceFingerprint() }}</code>
        <small>This identifier binds the admin session to this workstation.</small>
      </div>
    </div>

    <div class="actions">
      <button type="submit" class="primary" [disabled]="loginLoading()">
        {{ loginLoading() ? 'Authenticating…' : 'Authenticate' }}
      </button>
      <button type="button" class="ghost" (click)="logout()" [disabled]="!session()">
        Logout
      </button>
    </div>
  </form>

  <p class="alert error" *ngIf="loginError()">{{ loginError() }}</p>

  <section *ngIf="session() as activeSession" class="card session-summary">
    <div>
      <h2>Session Established</h2>
      <p>
        Signed in as <strong>{{ activeSession.admin.username }}</strong> · Role:
        {{ activeSession.admin.role }}
      </p>
      <p class="meta">
        Session ID: <code>{{ activeSession.session_id }}</code> · Token TTL:
        {{ activeSession.expires_in }}s
      </p>
    </div>
    <div class="summary-actions">
      <button type="button" (click)="loadTenants()" [disabled]="tenantsLoading()">Refresh Tenants</button>
      <button type="button" (click)="loadUsers()" [disabled]="usersLoading()">Refresh Users</button>
    </div>
  </section>

  <section *ngIf="session()" class="data-grid">
    <article class="card data-card">
      <header>
        <div>
          <h3>Tenant Overview</h3>
          <p>Cross-tenant visibility with per-tenant activity signals.</p>
        </div>
        <button type="button" (click)="loadTenants()" [disabled]="tenantsLoading()">Refresh</button>
      </header>

      <p class="alert error" *ngIf="tenantsError()">{{ tenantsError() }}</p>

      <div class="table-wrapper" *ngIf="tenants().length > 0; else emptyTenants">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Status</th>
              <th>Users</th>
              <th>Properties</th>
              <th>Active Properties</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let tenant of tenants(); trackBy: trackTenant">
              <td>
                <div class="user-cell">
                  <span class="name">{{ tenant.name }}</span>
                  <span class="meta">{{ tenant.slug }}</span>
                </div>
              </td>
              <td>
                <span class="badge" [class.active]="tenant.status === 'ACTIVE'">
                  {{ tenant.status }}
                </span>
              </td>
              <td>{{ tenant.user_count | number }}</td>
              <td>{{ tenant.property_count | number }}</td>
              <td>{{ tenant.active_properties | number }}</td>
              <td>{{ tenant.created_at | date: 'mediumDate' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <ng-template #emptyTenants>
        <p class="empty-state">
          {{ tenantsLoading() ? 'Loading tenants…' : 'No tenants were returned.' }}
        </p>
      </ng-template>
    </article>

    <article class="card data-card">
      <header>
        <div>
          <h3>Platform Users</h3>
          <p>Filter by tenant and initiate impersonation for least-privilege support.</p>
        </div>
        <button type="button" (click)="loadUsers()" [disabled]="usersLoading()">Refresh</button>
      </header>

      <form class="inline-form" [formGroup]="userFilterForm" (ngSubmit)="loadUsers()">
        <label>
          <span>Record Limit</span>
          <input type="number" formControlName="limit" min="1" max="500" />
        </label>
        <label>
          <span>Tenant ID (optional)</span>
          <input type="text" formControlName="tenant_id" placeholder="UUID" />
        </label>
        <button type="submit" class="primary" [disabled]="usersLoading()">Apply Filters</button>
      </form>

      <p class="alert error" *ngIf="usersError()">{{ usersError() }}</p>

      <div class="table-wrapper" *ngIf="users().length > 0; else emptyUsers">
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Status</th>
              <th>Last Login</th>
              <th>Memberships</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of users(); trackBy: trackUser">
              <td>
                <div class="user-cell">
                  <span class="name">{{ user.first_name }} {{ user.last_name }}</span>
                  <span class="meta">{{ user.username }} · {{ user.email }}</span>
                </div>
              </td>
              <td>
                <span class="badge" [class.active]="user.is_active">
                  {{ user.is_active ? 'Active' : 'Inactive' }}
                </span>
              </td>
              <td>{{ user.last_login_at ? (user.last_login_at | date: 'short') : 'Never' }}</td>
              <td>
                <ul class="tenants" *ngIf="user.tenants?.length; else noTenants">
                  <li *ngFor="let membership of user.tenants; trackBy: trackMembership">
                    <strong>{{ membership.tenant_name || membership.tenant_id }}</strong>
                    <span>{{ membership.role }}</span>
                  </li>
                </ul>
                <ng-template #noTenants>
                  <span class="empty-state">No tenant assignments</span>
                </ng-template>
              </td>
              <td>
                <button type="button" class="ghost" (click)="prefillImpersonation(user)">
                  Prefill Impersonation
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <ng-template #emptyUsers>
        <p class="empty-state">
          {{ usersLoading() ? 'Loading users…' : 'No users to display. Adjust filters and retry.' }}
        </p>
      </ng-template>
    </article>
  </section>

  <section *ngIf="session()" class="card impersonation-card">
    <header>
      <div>
        <h2>Impersonation Controls</h2>
        <p>Every request is recorded in the audit ledger and expires automatically.</p>
      </div>
    </header>

    <form class="impersonation-form" [formGroup]="impersonationForm" (ngSubmit)="startImpersonation()">
      <label>
        <span>Tenant ID</span>
        <input type="text" formControlName="tenant_id" placeholder="Tenant UUID" />
      </label>

      <label>
        <span>User ID</span>
        <input type="text" formControlName="user_id" placeholder="User UUID" />
      </label>

      <label>
        <span>Reason</span>
        <input type="text" formControlName="reason" placeholder="e.g. Investigating incident SEC-42" />
      </label>

      <label>
        <span>Ticket ID</span>
        <input type="text" formControlName="ticket_id" placeholder="SEC-0000" />
      </label>

      <div class="actions">
        <button type="submit" class="primary" [disabled]="impersonationLoading()">
          {{ impersonationLoading() ? 'Issuing Token…' : 'Generate Impersonation Token' }}
        </button>
      </div>
    </form>

    <p class="alert error" *ngIf="impersonationError()">{{ impersonationError() }}</p>

    <section class="token-preview" *ngIf="impersonationToken() as token">
      <header>
        <strong>Issued Access Token</strong>
        <span>Scope: {{ token.scope }} · TTL: {{ token.expires_in }}s</span>
      </header>
      <textarea readonly>{{ token.access_token }}</textarea>
      <div class="token-actions">
        <button type="button" class="ghost" (click)="copyToClipboard(token.access_token)">
          Copy Token
        </button>
      </div>
    </section>
  </section>
</section>
