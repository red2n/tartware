@if (tenant(); as tenant) {
  <div class="settings-page">
    <div class="page-header">
      <div>
        <h1 class="title">Settings Catalog</h1>
        <p class="subtitle">Explore configuration categories, scopes, and defaults for {{ tenant.name }}</p>
      </div>
      <div class="header-actions">
        <button mat-stroked-button (click)="toggleTheme()">
          <mat-icon>brightness_6</mat-icon>
          Toggle Theme
        </button>
        <button mat-flat-button color="primary" (click)="updateTenantProfile(tenant)">
          <mat-icon>manage_accounts</mat-icon>
          Tenant Profile
        </button>
      </div>
    </div>
    <div class="tenant-summary">
      <mat-card class="summary-card">
        <mat-card-header>
          <mat-icon mat-card-avatar>business</mat-icon>
          <mat-card-title>{{ tenant.name }}</mat-card-title>
          <mat-card-subtitle>{{ tenant.type }} • {{ tenant.status }}</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <dl class="summary-list">
            <div>
              <dt>Email</dt>
              <dd>{{ tenant.email }}</dd>
            </div>
            <div>
              <dt>Phone</dt>
              <dd>{{ tenant.phone || '—' }}</dd>
            </div>
            <div>
              <dt>Address</dt>
              <dd>{{ tenantAddress() }}</dd>
            </div>
          </dl>
        </mat-card-content>
      </mat-card>
      <mat-card class="summary-card">
        <mat-card-header>
          <mat-icon mat-card-avatar>subscriptions</mat-icon>
          <mat-card-title>Subscription</mat-card-title>
          <mat-card-subtitle>Plan & usage</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          @if (subscriptionPlan(); as subscription) {
            <dl class="summary-list">
              <div>
                <dt>Plan</dt>
                <dd>{{ subscription.plan || 'Enterprise' }}</dd>
              </div>
              <div>
                <dt>Status</dt>
                <dd>{{ subscription.status || 'Active' }}</dd>
              </div>
              <div>
                <dt>Seats</dt>
                <dd>{{ subscription.seats || tenant.user_count }}</dd>
              </div>
              <div>
                <dt>Properties</dt>
                <dd>{{ tenant.property_count }} total • {{ tenant.active_properties }} active</dd>
              </div>
            </dl>
          } @else {
            <p class="empty-copy">Subscription details are not available for this tenant.</p>
          }
        </mat-card-content>
      </mat-card>
    </div>
    <div class="catalog-layout">
      <aside class="catalog-sidebar">
        <div class="catalog-sidebar-header">
          <h2>Categories</h2>
          <span class="count-chip">{{ categories().length }}</span>
        </div>
        @if (catalogLoading()) {
          <div class="sidebar-loading">
            <mat-progress-spinner diameter="32" mode="indeterminate"></mat-progress-spinner>
          </div>
        } @else {
          <div class="category-list">
            @for (item of categories(); track item) {
              <button
                type="button"
                class="category-item"
                (click)="selectCategory(item.category.code)"
                [class.active]="item.category.code === selectedCategoryCode()"
                >
                <div class="category-icon">
                  <mat-icon>{{ item.category.icon || 'settings' }}</mat-icon>
                </div>
                <div class="category-meta">
                  <span class="name">{{ item.category.name }}</span>
                  <span class="description">{{ item.category.description }}</span>
                </div>
                <span class="badge">{{ item.sections.length }}</span>
              </button>
            }
          </div>
        }
        @if (catalogError()) {
          <p class="error-message">{{ catalogError() }}</p>
        }
      </aside>
      <section class="catalog-content">
        @if (!catalogLoading()) {
          @if (selectedCategory(); as aggregate) {
            <header class="category-overview">
              <div>
                <h2>{{ aggregate.category.name }}</h2>
                <p>{{ aggregate.category.description }}</p>
              </div>
              @if (aggregate.category.tags?.length) {
                <div class="category-tags">
                  @for (tag of aggregate.category.tags; track tag) {
                    <mat-chip appearance="outlined">
                      {{ tag }}
                    </mat-chip>
                  }
                </div>
              }
            </header>
            <div class="section-grid">
              @for (section of selectedSections(); track section) {
                <mat-card
                  class="section-card"
                  >
                  <mat-card-header>
                    <mat-icon mat-card-avatar>{{ section.section.icon || 'tune' }}</mat-icon>
                    <mat-card-title>{{ section.section.name }}</mat-card-title>
                    <mat-card-subtitle>{{ section.section.description }}</mat-card-subtitle>
                  </mat-card-header>
                  <mat-card-content>
                    @for (definition of section.definitions; track definition) {
                      <div
                        class="definition-card"
                        >
                        <div class="definition-header">
                          <div>
                            <h3>{{ definition.name }}</h3>
                            <p class="definition-description">{{ definition.description }}</p>
                          </div>
                          <span class="definition-code">{{ definition.code }}</span>
                        </div>
                        <div class="definition-meta">
                          <mat-chip appearance="outlined" color="primary">
                            {{ formatControlType(definition.control_type) }}
                          </mat-chip>
                          @for (scope of definition.allowed_scopes; track scope) {
                            <mat-chip
                              appearance="outlined"
                              matTooltip="Allowed scope"
                              >
                              {{ formatScope(scope) }}
                            </mat-chip>
                          }
                          @if (definition.sensitivity) {
                            <mat-chip
                              appearance="outlined"
                              class="sensitivity-chip"
                              >
                              {{ definition.sensitivity }}
                            </mat-chip>
                          }
                        </div>
                        @if (definition.tags?.length) {
                          <div class="definition-tags">
                            @for (tag of definition.tags; track tag) {
                              <mat-chip appearance="outlined">
                                {{ tag }}
                              </mat-chip>
                            }
                          </div>
                        }
                        @if (definition.options.length > 0) {
                          <div class="definition-options">
                            <h4>Options</h4>
                            <div class="options-list">
                              @for (option of definition.options; track option) {
                                <div class="option-item">
                                  <span class="option-label">{{ option.label }}</span>
                                  <span class="option-value">{{ option.value }}</span>
                                </div>
                              }
                            </div>
                          </div>
                        }
                        @if (definition.default_value) {
                          <div class="definition-default">
                            <h4>Default Value</h4>
                            <pre>{{ definition.default_value | json }}</pre>
                          </div>
                        }
                        @if (getCurrentValue(definition.id); as current) {
                          <div class="definition-current">
                            <h4>
                              Current Value
                              <span class="scope-label">{{ formatScope(current.scope) }}</span>
                            </h4>
                            <pre>{{ current.value | json }}</pre>
                            <span class="value-source">Source: {{ current.source }}</span>
                          </div>
                        }
                        @if (definition.reference_docs?.length) {
                          <div class="definition-links">
                            @for (link of definition.reference_docs; track link) {
                              <a
                                [href]="link"
                                target="_blank"
                                rel="noopener"
                                >
                                Reference
                              </a>
                            }
                          </div>
                        }
                      </div>
                    }
                  </mat-card-content>
                </mat-card>
              }
            </div>
          } @else {
            <div class="empty-state">
              <mat-icon>settings</mat-icon>
              <p>Select a category to view its configuration details.</p>
            </div>
          }
        } @else {
          <div class="loading-content">
            <mat-progress-spinner diameter="48" mode="indeterminate"></mat-progress-spinner>
          </div>
        }
      </section>
    </div>
  </div>
} @else {
  <mat-card class="table-card">
    <mat-card-content>
      <div class="loading-state">
        <mat-icon class="loading-icon text-blue-500">domain_disabled</mat-icon>
        <p>Select a tenant to configure settings.</p>
      </div>
    </mat-card-content>
  </mat-card>
}



