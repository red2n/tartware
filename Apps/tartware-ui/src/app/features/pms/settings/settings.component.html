<div class="settings-page" *ngIf="tenant() as tenant; else noTenant">
  <div class="page-header">
    <div>
      <h1 class="title">Settings Catalog</h1>
      <p class="subtitle">Explore configuration categories, scopes, and defaults for {{ tenant.name }}</p>
    </div>
    <div class="header-actions">
      <button mat-stroked-button (click)="toggleTheme()">
        <mat-icon>brightness_6</mat-icon>
        Toggle Theme
      </button>
      <button mat-flat-button color="primary" (click)="updateTenantProfile(tenant)">
        <mat-icon>manage_accounts</mat-icon>
        Tenant Profile
      </button>
    </div>
  </div>

  <div class="tenant-summary">
    <mat-card class="summary-card">
      <mat-card-header>
        <mat-icon mat-card-avatar>business</mat-icon>
        <mat-card-title>{{ tenant.name }}</mat-card-title>
        <mat-card-subtitle>{{ tenant.type }} • {{ tenant.status }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <dl class="summary-list">
          <div>
            <dt>Email</dt>
            <dd>{{ tenant.email }}</dd>
          </div>
          <div>
            <dt>Phone</dt>
            <dd>{{ tenant.phone || '—' }}</dd>
          </div>
          <div>
            <dt>Address</dt>
            <dd>{{ tenantAddress() }}</dd>
          </div>
        </dl>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card">
      <mat-card-header>
        <mat-icon mat-card-avatar>subscriptions</mat-icon>
        <mat-card-title>Subscription</mat-card-title>
        <mat-card-subtitle>Plan & usage</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        @if (subscriptionPlan(); as subscription) {
          <dl class="summary-list">
            <div>
              <dt>Plan</dt>
              <dd>{{ subscription.plan || 'Enterprise' }}</dd>
            </div>
            <div>
              <dt>Status</dt>
              <dd>{{ subscription.status || 'Active' }}</dd>
            </div>
            <div>
              <dt>Seats</dt>
              <dd>{{ subscription.seats || tenant.user_count }}</dd>
            </div>
            <div>
              <dt>Properties</dt>
              <dd>{{ tenant.property_count }} total • {{ tenant.active_properties }} active</dd>
            </div>
          </dl>
        } @else {
          <p class="empty-copy">Subscription details are not available for this tenant.</p>
        }
      </mat-card-content>
    </mat-card>
  </div>

  <div class="catalog-layout">
    <aside class="catalog-sidebar">
      <div class="catalog-sidebar-header">
        <h2>Categories</h2>
        <span class="count-chip">{{ categories().length }}</span>
      </div>
      <div *ngIf="catalogLoading(); else categoryList" class="sidebar-loading">
        <mat-progress-spinner diameter="32" mode="indeterminate"></mat-progress-spinner>
      </div>
      <ng-template #categoryList>
        <div class="category-list">
          <button
            type="button"
            class="category-item"
            *ngFor="let item of categories(); track trackCategory($index, item)"
            (click)="selectCategory(item.category.code)"
            [class.active]="item.category.code === selectedCategoryCode()"
          >
            <div class="category-icon">
              <mat-icon>{{ item.category.icon || 'settings' }}</mat-icon>
            </div>
            <div class="category-meta">
              <span class="name">{{ item.category.name }}</span>
              <span class="description">{{ item.category.description }}</span>
            </div>
            <span class="badge">{{ item.sections.length }}</span>
          </button>
        </div>
      </ng-template>
      <p class="error-message" *ngIf="catalogError()">{{ catalogError() }}</p>
    </aside>

    <section class="catalog-content">
      <ng-container *ngIf="!catalogLoading(); else loadingContent">
        <ng-container *ngIf="selectedCategory() as aggregate; else emptyState">
          <header class="category-overview">
            <div>
              <h2>{{ aggregate.category.name }}</h2>
              <p>{{ aggregate.category.description }}</p>
            </div>
            <div class="category-tags" *ngIf="aggregate.category.tags?.length">
              <mat-chip appearance="outlined" *ngFor="let tag of aggregate.category.tags">
                {{ tag }}
              </mat-chip>
            </div>
          </header>

          <div class="section-grid">
            <mat-card
              class="section-card"
              *ngFor="let section of selectedSections(); track trackSection($index, section)"
            >
              <mat-card-header>
                <mat-icon mat-card-avatar>{{ section.section.icon || 'tune' }}</mat-icon>
                <mat-card-title>{{ section.section.name }}</mat-card-title>
                <mat-card-subtitle>{{ section.section.description }}</mat-card-subtitle>
              </mat-card-header>
              <mat-card-content>
                <div
                  class="definition-card"
                  *ngFor="let definition of section.definitions; track trackDefinition($index, definition)"
                >
                  <div class="definition-header">
                    <div>
                      <h3>{{ definition.name }}</h3>
                      <p class="definition-description">{{ definition.description }}</p>
                    </div>
                    <span class="definition-code">{{ definition.code }}</span>
                  </div>

                  <div class="definition-meta">
                    <mat-chip appearance="outlined" color="primary">
                      {{ formatControlType(definition.control_type) }}
                    </mat-chip>
                    <mat-chip
                      appearance="outlined"
                      *ngFor="let scope of definition.allowed_scopes"
                      matTooltip="Allowed scope"
                    >
                      {{ formatScope(scope) }}
                    </mat-chip>
                    <mat-chip
                      appearance="outlined"
                      class="sensitivity-chip"
                      *ngIf="definition.sensitivity"
                    >
                      {{ definition.sensitivity }}
                    </mat-chip>
                  </div>

                  <div class="definition-tags" *ngIf="definition.tags?.length">
                    <mat-chip appearance="outlined" *ngFor="let tag of definition.tags">
                      {{ tag }}
                    </mat-chip>
                  </div>

                  <div class="definition-options" *ngIf="definition.options.length > 0">
                    <h4>Options</h4>
                    <div class="options-list">
                      <div class="option-item" *ngFor="let option of definition.options">
                        <span class="option-label">{{ option.label }}</span>
                        <span class="option-value">{{ option.value }}</span>
                      </div>
                    </div>
                  </div>

                  <div class="definition-default" *ngIf="definition.default_value">
                    <h4>Default Value</h4>
                    <pre>{{ definition.default_value | json }}</pre>
                  </div>

                  <div class="definition-current" *ngIf="getCurrentValue(definition.id) as current">
                    <h4>
                      Current Value
                      <span class="scope-label">{{ formatScope(current.scope) }}</span>
                    </h4>
                    <pre>{{ current.value | json }}</pre>
                    <span class="value-source">Source: {{ current.source }}</span>
                  </div>

                  <div class="definition-links" *ngIf="definition.reference_docs?.length">
                    <a
                      *ngFor="let link of definition.reference_docs"
                      [href]="link"
                      target="_blank"
                      rel="noopener"
                    >
                      Reference
                    </a>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </ng-container>
      </ng-container>
    </section>
  </div>
</div>

<ng-template #loadingContent>
  <div class="loading-content">
    <mat-progress-spinner diameter="48" mode="indeterminate"></mat-progress-spinner>
  </div>
</ng-template>

<ng-template #emptyState>
  <div class="empty-state">
    <mat-icon>settings</mat-icon>
    <p>Select a category to view its configuration details.</p>
  </div>
</ng-template>

<ng-template #noTenant>
  <mat-card class="table-card">
    <mat-card-content>
      <div class="loading-state">
        <mat-icon class="loading-icon text-blue-500">domain_disabled</mat-icon>
        <p>Select a tenant to configure settings.</p>
      </div>
    </mat-card-content>
  </mat-card>
</ng-template>
