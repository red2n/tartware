###############################################################################
# ROOMS SERVICE - Rooms & Room Types
# Routes via API Gateway (localhost:8080) -> rooms-service (port 3015)
#
# Content: Room Types, Rooms (CRUD + STATUS COMMANDS)
#
# WRITE OPERATIONS - Room Status via Command Center:
# See command-center.http for:
#   - rooms.status.update
#   - rooms.housekeeping_status.update
#   - rooms.inventory.block
#   - rooms.inventory.release
#   - rooms.out_of_order
#   - rooms.out_of_service
#   - rooms.features.update
#   - rooms.move
#
# Related files:
# - command-center.http - Status commands
# - rates.http - Rate plans and pricing
# - housekeeping.http - Housekeeping tasks
###############################################################################

# --- VARIABLES ---
@baseUrl = http://localhost:8080
@tenantId = 11111111-1111-1111-1111-111111111111
@propertyId = 22222222-2222-2222-2222-222222222222
@guestId = 33333333-3333-3333-3333-333333333333
@roomTypeId = 44444444-4444-4444-4444-444444444444
@room101Id = 55555555-5555-5555-5555-555555555551
@room102Id = 55555555-5555-5555-5555-555555555552

###############################################################################
# 1. LOGIN
###############################################################################

# @name login
POST {{baseUrl}}/v1/auth/login
Content-Type: application/json

{
  "username": "setup.admin",
  "password": "TempPass123"
}

### Extract token
@authToken = {{login.response.body.access_token}}

###############################################################################
# 2. ROOM TYPES - READ
###############################################################################

# List all room types for property
GET {{baseUrl}}/v1/room-types?tenant_id={{tenantId}}&property_id={{propertyId}}
Authorization: Bearer {{authToken}}

###
# Get room type by ID
GET {{baseUrl}}/v1/room-types/{{roomTypeId}}?tenant_id={{tenantId}}
Authorization: Bearer {{authToken}}

###############################################################################
# 3. ROOM TYPES - CREATE
###############################################################################

# @name createRoomType
# Create a new room type - Standard Room
POST {{baseUrl}}/v1/room-types
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}",
  "property_id": "{{propertyId}}",
  "type_name": "Standard Room",
  "type_code": "STD",
  "category": "STANDARD",
  "base_occupancy": 2,
  "max_occupancy": 3,
  "max_adults": 2,
  "max_children": 1,
  "extra_bed_capacity": 1,
  "number_of_beds": 1,
  "base_price": 99.00,
  "currency": "USD",
  "amenities": ["WIFI", "TV", "AC", "MINI_BAR"],
  "features": {
    "view": "garden",
    "smoking": false
  },
  "images": [],
  "description": "Comfortable standard room with modern amenities",
  "is_active": true,
  "display_order": 1,
  "metadata": {}
}

### Extract created room type ID
@newRoomTypeId = {{createRoomType.response.body.room_type_id}}

###
# Create Deluxe Suite
POST {{baseUrl}}/v1/room-types
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}",
  "property_id": "{{propertyId}}",
  "type_name": "Deluxe Suite",
  "type_code": "DLX",
  "category": "SUITE",
  "base_occupancy": 2,
  "max_occupancy": 4,
  "max_adults": 2,
  "max_children": 2,
  "extra_bed_capacity": 2,
  "number_of_beds": 1,
  "base_price": 199.00,
  "currency": "USD",
  "amenities": ["WIFI", "TV", "AC", "MINI_BAR", "JACUZZI", "BALCONY"],
  "features": {
    "view": "city",
    "smoking": false,
    "size_sqm": 45
  },
  "images": [],
  "description": "Spacious deluxe suite with city views",
  "is_active": true,
  "display_order": 2,
  "metadata": {}
}

###############################################################################
# 4. ROOM TYPES - UPDATE
###############################################################################

# Update room type details
PUT {{baseUrl}}/v1/room-types/{{roomTypeId}}
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}",
  "type_name": "Cityline King Room",
  "base_price": 219.00,
  "amenities": ["WIFI", "SMART_TV", "WORK_DESK", "RAIN_SHOWER", "COFFEE_MAKER"]
}

###
# Update active status and display order
PUT {{baseUrl}}/v1/room-types/{{roomTypeId}}
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}",
  "is_active": true,
  "display_order": 1
}

###############################################################################
# 4B. ROOM TYPES - PARTIAL UPDATE (PATCH)
###############################################################################

###
# Partial update - change only base price
PATCH {{baseUrl}}/v1/room-types/{{roomTypeId}}
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}",
  "base_price": 229.00
}

###
# Partial update - update amenities only
PATCH {{baseUrl}}/v1/room-types/{{roomTypeId}}
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}",
  "amenities": ["WIFI", "SMART_TV", "WORK_DESK", "RAIN_SHOWER", "COFFEE_MAKER", "MINIBAR"]
}

###############################################################################
# 5. ROOMS - READ
###############################################################################

# List all rooms for tenant
GET {{baseUrl}}/v1/rooms?tenant_id={{tenantId}}&limit=50
Authorization: Bearer {{authToken}}

###
# List rooms for specific property
GET {{baseUrl}}/v1/rooms?tenant_id={{tenantId}}&property_id={{propertyId}}&limit=50
Authorization: Bearer {{authToken}}

###
# Filter rooms by status
GET {{baseUrl}}/v1/rooms?tenant_id={{tenantId}}&status=available
Authorization: Bearer {{authToken}}

###
# Filter rooms by housekeeping status
GET {{baseUrl}}/v1/rooms?tenant_id={{tenantId}}&housekeeping_status=clean
Authorization: Bearer {{authToken}}

###############################################################################
# 5A. ROOM AVAILABILITY SEARCH
# Search for available rooms across a date range
###############################################################################

### Search available rooms for dates
GET {{baseUrl}}/v1/rooms/availability?tenant_id={{tenantId}}&property_id={{propertyId}}&check_in_date=2026-03-15&check_out_date=2026-03-18&adults=2&children=0
Authorization: Bearer {{authToken}}

###
# Search available rooms with room type filter
GET {{baseUrl}}/v1/rooms/availability?tenant_id={{tenantId}}&property_id={{propertyId}}&check_in_date=2026-03-15&check_out_date=2026-03-18&room_type_id={{roomTypeId}}&adults=2&children=0
Authorization: Bearer {{authToken}}

###
# Search available rooms for family (with children)
GET {{baseUrl}}/v1/rooms/availability?tenant_id={{tenantId}}&property_id={{propertyId}}&check_in_date=2026-04-01&check_out_date=2026-04-05&adults=2&children=2
Authorization: Bearer {{authToken}}

###############################################################################
# 5B. ROOMS - READ WITH RECOMMENDATIONS
# When guest context is provided, rooms are ranked by recommendation score
# Requires: recommendation-service running (npm run dev:recommendation)
###############################################################################

### List rooms with personalized recommendations
# Returns rooms sorted by recommendation_rank with recommendation_score and recommendation_reasons
GET {{baseUrl}}/v1/rooms?tenant_id={{tenantId}}&property_id={{propertyId}}&check_in_date=2025-02-10&check_out_date=2025-02-12&adults=2&children=0&limit=50
Authorization: Bearer {{authToken}}

###
# Rooms with guest context for better personalization
GET {{baseUrl}}/v1/rooms?tenant_id={{tenantId}}&property_id={{propertyId}}&guest_id={{guestId}}&check_in_date=2025-03-15&check_out_date=2025-03-18&adults=2&children=1&limit=50
Authorization: Bearer {{authToken}}

###
# Combined filters with recommendations
GET {{baseUrl}}/v1/rooms?tenant_id={{tenantId}}&property_id={{propertyId}}&status=available&check_in_date=2025-04-01&check_out_date=2025-04-05&adults=1&children=0&limit=50
Authorization: Bearer {{authToken}}

###############################################################################

###
# Get room by ID
GET {{baseUrl}}/v1/rooms/{{room101Id}}?tenant_id={{tenantId}}
Authorization: Bearer {{authToken}}

###
# Get room by ID with recommendation scoring
# Returns recommendation_rank, recommendation_score, recommendation_reasons
GET {{baseUrl}}/v1/rooms/{{room101Id}}?tenant_id={{tenantId}}&check_in_date=2025-02-10&check_out_date=2025-02-12&adults=2&children=0
Authorization: Bearer {{authToken}}

###
# Get room by ID with guest context for personalized scoring
GET {{baseUrl}}/v1/rooms/{{room102Id}}?tenant_id={{tenantId}}&guest_id={{guestId}}&check_in_date=2025-03-15&check_out_date=2025-03-18&adults=2&children=1
Authorization: Bearer {{authToken}}

###############################################################################
# 6. ROOMS - CREATE
###############################################################################

# @name createRoom
# Create a new room
POST {{baseUrl}}/v1/rooms
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}",
  "property_id": "{{propertyId}}",
  "room_type_id": "{{roomTypeId}}",
  "room_number": "301",
  "floor": "3",
  "features": {
    "view": "pool",
    "balcony": true,
    "smoking": false
  },
  "status": "available",
  "housekeeping_status": "clean",
  "maintenance_status": "operational",
  "is_blocked": false,
  "is_out_of_order": false
}

### Extract created room ID
@newRoomId = {{createRoom.response.body.room_id}}

###############################################################################
# 7. ROOMS - UPDATE
###############################################################################

# Update room details
PUT {{baseUrl}}/v1/rooms/{{room101Id}}
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}",
  "features": {
    "view": "city",
    "balcony": true,
    "smoking": false,
    "accessible": false
  }
}

###############################################################################
# 7B. ROOMS - UPDATE (housekeeping/maintenance)
###############################################################################

# Update room housekeeping and maintenance status
PUT {{baseUrl}}/v1/rooms/{{room101Id}}
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}",
  "housekeeping_status": "clean",
  "maintenance_status": "operational"
}

###############################################################################
# 8. ROOMS - DELETE
###############################################################################

# Delete a room (soft delete)
DELETE {{baseUrl}}/v1/rooms/{{newRoomId}}
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}"
}

###############################################################################
# 9. ROOM TYPES - DELETE
###############################################################################

# Delete a room type (soft delete)
DELETE {{baseUrl}}/v1/room-types/{{newRoomTypeId}}
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}"
}

###############################################################################
# 10. ROOM STATUS COMMANDS (via Command Center)
# These endpoints represent the desired behavior.
# Implementation via Command Center - see command-center.http
###############################################################################

#
# NOTE: Room status updates go through the Command Center for event sourcing.
# See command-center.http for full command examples.
#
# Command patterns:
#   POST /v1/commands/rooms.room.update_status/execute
#   POST /v1/commands/rooms.room.update_housekeeping/execute
#   POST /v1/commands/rooms.room.block/execute
#   POST /v1/commands/rooms.room.release/execute
#   POST /v1/commands/rooms.room.out_of_order/execute
#   POST /v1/commands/rooms.room.return_to_service/execute
#   POST /v1/commands/rooms.room.update_features/execute
#

###############################################################################
# 11. REST-STYLE COMMAND DISPATCH
# Alternative to /v1/commands/{name}/execute pattern
# These routes dispatch commands via the gateway
###############################################################################

###
# Block room inventory
POST {{baseUrl}}/v1/tenants/{{tenantId}}/rooms/{{room101Id}}/block
Content-Type: application/json
Authorization: Bearer {{authToken}}
X-Request-ID: {{$guid}}
X-Idempotency-Key: room-block-{{$timestamp}}

{
  "property_id": "{{propertyId}}",
  "block_type": "MAINTENANCE",
  "start_date": "2026-02-10",
  "end_date": "2026-02-12",
  "reason": "HVAC system repair",
  "notes": "Scheduled preventive maintenance",
  "notify_housekeeping": true
}

###
# Release room block
POST {{baseUrl}}/v1/tenants/{{tenantId}}/rooms/{{room101Id}}/release
Content-Type: application/json
Authorization: Bearer {{authToken}}
X-Request-ID: {{$guid}}
X-Idempotency-Key: room-release-{{$timestamp}}

{
  "property_id": "{{propertyId}}",
  "reason": "Maintenance completed ahead of schedule"
}

###
# Update room status
POST {{baseUrl}}/v1/tenants/{{tenantId}}/rooms/{{room101Id}}/status
Content-Type: application/json
Authorization: Bearer {{authToken}}
X-Request-ID: {{$guid}}
X-Idempotency-Key: room-status-{{$timestamp}}

{
  "property_id": "{{propertyId}}",
  "status": "OCCUPIED",
  "notes": "Guest checked in"
}

###
# Update housekeeping status
POST {{baseUrl}}/v1/tenants/{{tenantId}}/rooms/{{room101Id}}/housekeeping-status
Content-Type: application/json
Authorization: Bearer {{authToken}}
X-Request-ID: {{$guid}}
X-Idempotency-Key: room-hk-{{$timestamp}}

{
  "property_id": "{{propertyId}}",
  "housekeeping_status": "CLEAN",
  "inspected_by": "{{guestId}}",
  "inspection_notes": "Room passed QA check"
}

###
# Mark room out of order
POST {{baseUrl}}/v1/tenants/{{tenantId}}/rooms/{{room101Id}}/out-of-order
Content-Type: application/json
Authorization: Bearer {{authToken}}
X-Request-ID: {{$guid}}
X-Idempotency-Key: room-ooo-{{$timestamp}}

{
  "property_id": "{{propertyId}}",
  "reason": "Water damage from burst pipe",
  "estimated_return_date": "2026-02-15",
  "maintenance_ticket": "MT-2026-001",
  "notify_reservations": true,
  "reassign_existing_bookings": true
}

###
# Mark room out of service
POST {{baseUrl}}/v1/tenants/{{tenantId}}/rooms/{{room101Id}}/out-of-service
Content-Type: application/json
Authorization: Bearer {{authToken}}
X-Request-ID: {{$guid}}
X-Idempotency-Key: room-oos-{{$timestamp}}

{
  "property_id": "{{propertyId}}",
  "reason": "Deep cleaning scheduled",
  "estimated_return_date": "2026-02-20",
  "notes": "Quarterly deep clean"
}

###
# Update room features
POST {{baseUrl}}/v1/tenants/{{tenantId}}/rooms/{{room101Id}}/features
Content-Type: application/json
Authorization: Bearer {{authToken}}
X-Request-ID: {{$guid}}
X-Idempotency-Key: room-features-{{$timestamp}}

{
  "property_id": "{{propertyId}}",
  "features": {
    "view": "CITY",
    "balcony": true,
    "smoking": false,
    "accessible": true,
    "connecting_room": "102",
    "crib_available": true,
    "rollaway_available": true
  },
  "amenities": ["WIFI", "SMART_TV", "WORK_DESK", "RAIN_SHOWER", "COFFEE_MAKER", "SAFE"]
}

###############################################################################
# REFERENCE
###############################################################################
#
# ROOM STATUSES:
#   available, occupied, checkout, vacant_dirty, vacant_clean,
#   out_of_order, out_of_service, blocked
#
# HOUSEKEEPING STATUSES:
#   clean, dirty, inspected, in_progress
#
# MAINTENANCE STATUSES:
#   operational, needs_repair, under_repair
#
# ROOM CATEGORIES:
#   STANDARD, SUPERIOR, DELUXE, SUITE, PENTHOUSE, VILLA
#
# COMMAND CENTER OPERATIONS:
#   All room status updates go through the Command Center.
#   See command-center.http for full examples of:
#     POST /v1/commands/rooms.status.update/execute
#     POST /v1/commands/rooms.housekeeping_status.update/execute
#     POST /v1/commands/rooms.inventory.block/execute
#     POST /v1/commands/rooms.inventory.release/execute
#     POST /v1/commands/rooms.out_of_order/execute
#     POST /v1/commands/rooms.out_of_service/execute
#     POST /v1/commands/rooms.features.update/execute
#     POST /v1/commands/rooms.move/execute
#
# REST-STYLE COMMAND DISPATCH (alternative pattern):
#   POST /v1/tenants/:tenantId/rooms/:roomId/block
#   POST /v1/tenants/:tenantId/rooms/:roomId/release
#   POST /v1/tenants/:tenantId/rooms/:roomId/status
#   POST /v1/tenants/:tenantId/rooms/:roomId/housekeeping-status
#   POST /v1/tenants/:tenantId/rooms/:roomId/out-of-order
#   POST /v1/tenants/:tenantId/rooms/:roomId/out-of-service
#   POST /v1/tenants/:tenantId/rooms/:roomId/features
#
# SAMPLE IDs:
#   Tenant:    11111111-1111-1111-1111-111111111111
#   Property:  22222222-2222-2222-2222-222222222222
#   Room Type: 44444444-4444-4444-4444-444444444444 (Cityline King)
#   Room 101:  55555555-5555-5555-5555-555555555551
#   Room 102:  55555555-5555-5555-5555-555555555552
#   Room 201:  55555555-5555-5555-5555-555555555553
#   Room 202:  55555555-5555-5555-5555-555555555554
#
###############################################################################
