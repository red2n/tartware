###############################################################################
# CORE SERVICE - Auth, Users & Associations
# Routes via API Gateway (localhost:8080) -> core-service (port 3000)
#
# Content: Authentication, Users, User-Tenant Associations, System Admin
#
# Related files:
# - tenantandproperty.http - Tenants, Properties, Dashboard
# - modules.http - Modules catalog
# - reports.http - Performance reports
###############################################################################

# --- VARIABLES ---
@baseUrl = http://localhost:8080
@tenantId = 11111111-1111-1111-1111-111111111111
@userId = 33333333-3333-3333-3333-333333333333

###############################################################################
# 1. AUTHENTICATION - LOGIN
###############################################################################

# @name login
# Valid login - setup.admin (OWNER role)
POST {{baseUrl}}/v1/auth/login
Content-Type: application/json

{
  "username": "setup.admin",
  "password": "TempPass123"
}

### Extract token for subsequent requests
@authToken = {{login.response.body.access_token}}

###
# Invalid login - wrong password
POST {{baseUrl}}/v1/auth/login
Content-Type: application/json

{
  "username": "setup.admin",
  "password": "WrongPassword"
}

###
# Invalid login - missing username
POST {{baseUrl}}/v1/auth/login
Content-Type: application/json

{
  "password": "TempPass123"
}

###############################################################################
# 2. AUTH CONTEXT & PASSWORD
###############################################################################

# Get auth context (memberships, authorized tenants)
GET {{baseUrl}}/v1/auth/context
Authorization: Bearer {{authToken}}

###
# Change password (requires valid current password)
POST {{baseUrl}}/v1/auth/change-password
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "current_password": "TempPass123",
  "new_password": "NewSecure123!"
}

###############################################################################
# 3. MFA ENROLLMENT
###############################################################################

# Start MFA enrollment (returns secret and otpauth_url)
POST {{baseUrl}}/v1/auth/mfa/enroll
Authorization: Bearer {{authToken}}

###
# Verify MFA code to enable MFA
POST {{baseUrl}}/v1/auth/mfa/verify
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "mfa_code": "123456"
}

###
# Rotate MFA secret (requires current MFA code)
POST {{baseUrl}}/v1/auth/mfa/rotate
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "mfa_code": "123456"
}

###############################################################################
# 4. USER MANAGEMENT
###############################################################################

# List users for Tartware tenant
GET {{baseUrl}}/v1/users?tenant_id={{tenantId}}&limit=50
Authorization: Bearer {{authToken}}

###
# Get user by ID
GET {{baseUrl}}/v1/users/{{userId}}
Authorization: Bearer {{authToken}}

###
# Create a new tenant user (requires ADMIN+ role)
# @name createUser
POST {{baseUrl}}/v1/users
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}",
  "username": "test.staff",
  "email": "staff@tartware.demo",
  "password": "TempPass123",
  "first_name": "Test",
  "last_name": "Staff",
  "role": "STAFF"
}

###
# Update user details
PUT {{baseUrl}}/v1/users/{{userId}}
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "first_name": "Updated",
  "last_name": "Name"
}

###
# Reset a user's password (requires ADMIN+ role)
POST {{baseUrl}}/v1/users/reset-password
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}",
  "user_id": "{{userId}}",
  "new_password": "NewTempPass123"
}

###############################################################################
# 5. USER-TENANT ASSOCIATIONS
###############################################################################

# List user-tenant associations
GET {{baseUrl}}/v1/user-tenant-associations?tenant_id={{tenantId}}&limit=50
Authorization: Bearer {{authToken}}

###
# Filter associations by role
GET {{baseUrl}}/v1/user-tenant-associations?tenant_id={{tenantId}}&role=OWNER
Authorization: Bearer {{authToken}}

###
# Filter associations by active status
GET {{baseUrl}}/v1/user-tenant-associations?tenant_id={{tenantId}}&is_active=true
Authorization: Bearer {{authToken}}

###
# Update user's tenant role
POST {{baseUrl}}/v1/user-tenant-associations/role
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}",
  "user_id": "{{userId}}",
  "role": "ADMIN"
}

###
# Toggle user's tenant access status
POST {{baseUrl}}/v1/user-tenant-associations/status
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}",
  "user_id": "{{userId}}",
  "is_active": true
}

###############################################################################
# 6. SYSTEM ADMIN AUTHENTICATION
###############################################################################
# NOTE: These endpoints require system administrator credentials

# System admin login (requires MFA if enabled)
POST {{baseUrl}}/v1/system/auth/login
Content-Type: application/json

{
  "username": "setup.admin",
  "password": "TempPass123",
  "device_fingerprint": "test-device-001"
}

###
# Emergency break-glass login
POST {{baseUrl}}/v1/system/auth/break-glass
Content-Type: application/json

{
  "username": "setup.admin",
  "break_glass_code": "EMERGENCY-CODE",
  "reason": "Production incident requiring immediate system access",
  "ticket_id": "TICKET-2026-001",
  "device_fingerprint": "test-device-001"
}

###############################################################################
# 7. SYSTEM ADMIN - IMPERSONATION
###############################################################################

# Start tenant impersonation session
POST {{baseUrl}}/v1/system/impersonate
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}",
  "user_id": "{{userId}}",
  "reason": "Customer support investigation - TICKET-2026-001",
  "ticket_id": "TICKET-2026-001"
}

###############################################################################
# REFERENCE
###############################################################################
#
# TENANT ROLES:
#   OWNER   - Full tenant access, can manage all users
#   ADMIN   - Administrative access, can create/modify users
#   MANAGER - Operational management
#   STAFF   - Standard access, limited to assigned tasks
#   VIEWER  - Read-only access
#
# SYSTEM ROLES:
#   SYSTEM_SUPER_ADMIN - Full platform access
#   SYSTEM_ADMIN       - Create tenants/users
#   SYSTEM_OPERATOR    - Read-only monitoring
#   SYSTEM_SUPPORT     - Can impersonate tenant users
#
# SAMPLE IDs:
#   Tenant:   11111111-1111-1111-1111-111111111111 (Tartware Hospitality Labs)
#   Property: 22222222-2222-2222-2222-222222222222 (Tartware City Center)
#   User:     33333333-3333-3333-3333-333333333333 (setup.admin)
#
###############################################################################
