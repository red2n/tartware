###############################################################################
# RESERVATIONS SERVICE - Booking Management
# Routes via API Gateway (localhost:8080) -> core-service (port 3000)
#
# Content: Reservation Listing and Filtering (READ OPERATIONS)
#
# WRITE OPERATIONS: All reservation write operations go through the
# Command Center. See command-center.http for:
#   - reservation.create
#   - reservation.modify
#   - reservation.cancel
#   - reservation.check_in
#   - reservation.check_out
#   - reservation.assign_room
#   - reservation.unassign_room
#   - reservation.extend_stay
#   - reservation.rate_override
#   - reservation.add_deposit
#   - reservation.release_deposit
#
# Related files:
# - command-center.http - Write operations (commands)
# - guests.http - Guest profiles
# - rooms.http - Room inventory
# - rates.http - Rate plans
# - billing.http - Payments
###############################################################################

# --- VARIABLES ---
@baseUrl = http://localhost:8080
@tenantId = 11111111-1111-1111-1111-111111111111
@propertyId = 22222222-2222-2222-2222-222222222222
@roomTypeId = 44444444-4444-4444-4444-444444444444
@room101Id = 55555555-5555-5555-5555-555555555551

###############################################################################
# 1. LOGIN
###############################################################################

# @name login
POST {{baseUrl}}/v1/auth/login
Content-Type: application/json

{
  "username": "setup.admin",
  "password": "TempPass123"
}

### Extract token
@authToken = {{login.response.body.access_token}}

###############################################################################
# 2. RESERVATIONS - LIST WITH FILTERS
###############################################################################

# List all reservations for tenant
GET {{baseUrl}}/v1/reservations?tenant_id={{tenantId}}&limit=50
Authorization: Bearer {{authToken}}

###
# List reservations for specific property
GET {{baseUrl}}/v1/reservations?tenant_id={{tenantId}}&property_id={{propertyId}}&limit=50
Authorization: Bearer {{authToken}}

###
# Filter by status - CONFIRMED
GET {{baseUrl}}/v1/reservations?tenant_id={{tenantId}}&status=confirmed
Authorization: Bearer {{authToken}}

###
# Filter by status - CHECKED_IN
GET {{baseUrl}}/v1/reservations?tenant_id={{tenantId}}&status=checked_in
Authorization: Bearer {{authToken}}

###
# Filter by status - CHECKED_OUT
GET {{baseUrl}}/v1/reservations?tenant_id={{tenantId}}&status=checked_out
Authorization: Bearer {{authToken}}

###
# Filter by status - PENDING
GET {{baseUrl}}/v1/reservations?tenant_id={{tenantId}}&status=pending
Authorization: Bearer {{authToken}}

###
# Filter by status - CANCELLED
GET {{baseUrl}}/v1/reservations?tenant_id={{tenantId}}&status=cancelled
Authorization: Bearer {{authToken}}

###
# Filter by status - NO_SHOW
GET {{baseUrl}}/v1/reservations?tenant_id={{tenantId}}&status=no_show
Authorization: Bearer {{authToken}}

###
# Filter by guest_id
GET {{baseUrl}}/v1/reservations?tenant_id={{tenantId}}&guest_id={{guestId}}
Authorization: Bearer {{authToken}}

###
# Filter by room_type_id
GET {{baseUrl}}/v1/reservations?tenant_id={{tenantId}}&room_type_id={{roomTypeId}}
Authorization: Bearer {{authToken}}

###
# Filter by date range (check_in)
GET {{baseUrl}}/v1/reservations?tenant_id={{tenantId}}&check_in_from=2026-01-30&check_in_to=2026-02-05
Authorization: Bearer {{authToken}}

###
# Filter by date range (check_out)
GET {{baseUrl}}/v1/reservations?tenant_id={{tenantId}}&check_out_from=2026-02-01&check_out_to=2026-02-15
Authorization: Bearer {{authToken}}

###
# Combine property and status filters
GET {{baseUrl}}/v1/reservations?tenant_id={{tenantId}}&property_id={{propertyId}}&status=confirmed
Authorization: Bearer {{authToken}}

###
# Get larger batch of reservations
GET {{baseUrl}}/v1/reservations?tenant_id={{tenantId}}&limit=200
Authorization: Bearer {{authToken}}

###############################################################################
# 2B. SINGLE RESERVATION DETAIL
###############################################################################

@reservationId = 44444444-4444-4444-4444-444444444444

###
# Get a single reservation by ID (with folio and status history)
GET {{baseUrl}}/v1/reservations/{{reservationId}}?tenant_id={{tenantId}}
Authorization: Bearer {{authToken}}

###############################################################################
# 2C. TENANT-SCOPED RESERVATION ACCESS
###############################################################################

###
# List reservations scoped to tenant (REST-style URL)
GET {{baseUrl}}/v1/tenants/{{tenantId}}/reservations
Authorization: Bearer {{authToken}}

###
# Create reservation via tenant-scoped route
POST {{baseUrl}}/v1/tenants/{{tenantId}}/reservations
Content-Type: application/json
Authorization: Bearer {{authToken}}
X-Request-ID: {{$guid}}
X-Idempotency-Key: tenant-res-{{$timestamp}}

{
  "property_id": "{{propertyId}}",
  "guest_id": "33333333-3333-3333-3333-333333333333",
  "room_type_id": "{{roomTypeId}}",
  "rate_code": "BAR",
  "check_in_date": "2026-04-01",
  "check_out_date": "2026-04-04",
  "adults": 2,
  "children": 0,
  "source": "DIRECT",
  "channel": "WEB"
}

###############################################################################
# 3. RESERVATION LIFECYCLE - Event Sourcing State Inspection
###############################################################################

###
# Get reservation lifecycle states (event sourcing inspection)
GET {{baseUrl}}/v1/reservations/{{reservationId}}/lifecycle?tenant_id={{tenantId}}
Authorization: Bearer {{authToken}}

###
# Pre-check-in guest recognition brief (S23)
# Returns VIP status, preferences, allergies, notes, loyalty, special requests
GET {{baseUrl}}/v1/reservations/{{reservationId}}/check-in-brief?tenant_id={{tenantId}}
Authorization: Bearer {{authToken}}

###############################################################################
# 4. REST-STYLE COMMAND DISPATCH
# Alternative to /v1/commands/{name}/execute pattern
# These routes dispatch commands via the gateway
###############################################################################

###
# Check-in a guest
POST {{baseUrl}}/v1/tenants/{{tenantId}}/reservations/{{reservationId}}/check-in
Content-Type: application/json
Authorization: Bearer {{authToken}}
X-Request-ID: {{$guid}}
X-Idempotency-Key: checkin-{{$timestamp}}

{
  "room_id": "{{room101Id}}",
  "id_verified": true,
  "id_type": "PASSPORT",
  "id_number": "AB1234567",
  "registration_card_signed": true,
  "key_cards_issued": 2,
  "notes": "Guest arrived at 3:15 PM"
}

###
# Check-out a guest
POST {{baseUrl}}/v1/tenants/{{tenantId}}/reservations/{{reservationId}}/check-out
Content-Type: application/json
Authorization: Bearer {{authToken}}
X-Request-ID: {{$guid}}
X-Idempotency-Key: checkout-{{$timestamp}}

{
  "express_checkout": false,
  "room_inspected": true,
  "keys_returned": 2,
  "minibar_charges": 25.00,
  "late_checkout_fee": 0,
  "folio_settled": true,
  "notes": "Smooth checkout"
}

###
# Assign room to reservation
POST {{baseUrl}}/v1/tenants/{{tenantId}}/reservations/{{reservationId}}/assign-room
Content-Type: application/json
Authorization: Bearer {{authToken}}
X-Request-ID: {{$guid}}
X-Idempotency-Key: assign-{{$timestamp}}

{
  "room_id": "{{room101Id}}",
  "notes": "Upgraded to high floor as requested"
}

###
# Unassign room from reservation
POST {{baseUrl}}/v1/tenants/{{tenantId}}/reservations/{{reservationId}}/unassign-room
Content-Type: application/json
Authorization: Bearer {{authToken}}
X-Request-ID: {{$guid}}
X-Idempotency-Key: unassign-{{$timestamp}}

{
  "reason": "Room requires maintenance, reassigning"
}

###
# Extend stay
POST {{baseUrl}}/v1/tenants/{{tenantId}}/reservations/{{reservationId}}/extend
Content-Type: application/json
Authorization: Bearer {{authToken}}
X-Request-ID: {{$guid}}
X-Idempotency-Key: extend-{{$timestamp}}

{
  "new_check_out_date": "2026-03-20",
  "rate_code": "BAR",
  "additional_amount": 209.00,
  "reason": "Guest requested 2-day extension"
}

###
# Rate override
POST {{baseUrl}}/v1/tenants/{{tenantId}}/reservations/{{reservationId}}/rate-override
Content-Type: application/json
Authorization: Bearer {{authToken}}
X-Request-ID: {{$guid}}
X-Idempotency-Key: rate-override-{{$timestamp}}

{
  "new_rate": 179.00,
  "reason": "Price match guarantee",
  "authorization": "MGR-APPROVAL-001"
}

###
# Add deposit
POST {{baseUrl}}/v1/tenants/{{tenantId}}/reservations/{{reservationId}}/deposit/add
Content-Type: application/json
Authorization: Bearer {{authToken}}
X-Request-ID: {{$guid}}
X-Idempotency-Key: deposit-add-{{$timestamp}}

{
  "amount": 200.00,
  "currency": "USD",
  "payment_method": "CREDIT_CARD",
  "card_last_four": "4242",
  "authorization_code": "AUTH-123456",
  "notes": "Security deposit"
}

###
# Release deposit
POST {{baseUrl}}/v1/tenants/{{tenantId}}/reservations/{{reservationId}}/deposit/release
Content-Type: application/json
Authorization: Bearer {{authToken}}
X-Request-ID: {{$guid}}
X-Idempotency-Key: deposit-release-{{$timestamp}}

{
  "amount": 200.00,
  "reason": "No damages, full refund",
  "refund_method": "ORIGINAL_PAYMENT_METHOD"
}

###
# Cancel a reservation
POST {{baseUrl}}/v1/tenants/{{tenantId}}/reservations/{{reservationId}}/cancel
Content-Type: application/json
Authorization: Bearer {{authToken}}
X-Request-ID: {{$guid}}
X-Idempotency-Key: cancel-{{$timestamp}}

{
  "reason": "Guest requested cancellation",
  "cancellation_fee": 0,
  "refund_deposits": true,
  "notify_guest": true
}

###
# Mark reservation as no-show
POST {{baseUrl}}/v1/tenants/{{tenantId}}/reservations/{{reservationId}}/no-show
Content-Type: application/json
Authorization: Bearer {{authToken}}
X-Request-ID: {{$guid}}
X-Idempotency-Key: noshow-{{$timestamp}}

{
  "no_show_fee": 150.00,
  "charge_first_night": true,
  "notes": "Guest did not arrive by cutoff time"
}

###
# Walk-in express check-in (create + assign + check-in atomically)
POST {{baseUrl}}/v1/tenants/{{tenantId}}/reservations/walk-in
Content-Type: application/json
Authorization: Bearer {{authToken}}
X-Request-ID: {{$guid}}
X-Idempotency-Key: walkin-{{$timestamp}}

{
  "property_id": "{{propertyId}}",
  "guest_first_name": "Walk-In",
  "guest_last_name": "Guest",
  "guest_email": "walkin@example.com",
  "room_type_id": "{{roomTypeId}}",
  "room_id": "{{room101Id}}",
  "check_in_date": "2026-02-09",
  "check_out_date": "2026-02-10",
  "number_of_adults": 1,
  "number_of_children": 0,
  "rate_code": "BAR",
  "room_rate": 199.00,
  "payment_method": "CREDIT_CARD",
  "id_verified": true,
  "id_type": "DRIVERS_LICENSE"
}

###
# Add to room waitlist
POST {{baseUrl}}/v1/tenants/{{tenantId}}/reservations/waitlist
Content-Type: application/json
Authorization: Bearer {{authToken}}
X-Request-ID: {{$guid}}
X-Idempotency-Key: waitlist-add-{{$timestamp}}

{
  "property_id": "{{propertyId}}",
  "guest_id": "{{guestId}}",
  "room_type_id": "{{roomTypeId}}",
  "desired_check_in": "2026-03-15",
  "desired_check_out": "2026-03-18",
  "adults": 2,
  "children": 0,
  "priority": "NORMAL",
  "notes": "Flexible on dates, prefer high floor"
}

###
# Convert waitlist entry to confirmed reservation
POST {{baseUrl}}/v1/tenants/{{tenantId}}/reservations/waitlist/{{waitlistId}}/convert
Content-Type: application/json
Authorization: Bearer {{authToken}}
X-Request-ID: {{$guid}}
X-Idempotency-Key: waitlist-convert-{{$timestamp}}

{
  "rate_code": "BAR",
  "room_rate": 209.00,
  "send_confirmation": true
}

###############################################################################
# REFERENCE
###############################################################################
#
# RESERVATION STATUSES (for filtering):
#   pending, confirmed, checked_in, checked_out, cancelled, no_show
#
# BOOKING SOURCES:
#   DIRECT, OTA, GDS, CORPORATE, WALK_IN, PHONE, EMAIL
#
# BOOKING CHANNELS:
#   WEB, MOBILE, PHONE, WALK_IN, BOOKING_COM, EXPEDIA, AIRBNB
#
# PAYMENT METHODS:
#   CREDIT_CARD, DEBIT_CARD, CASH, BANK_TRANSFER, INVOICE, VIRTUAL_CARD
#
# WRITE OPERATIONS:
#   All reservation write operations go through the Command Center.
#   See command-center.http for full examples of:
#     POST /v1/commands/reservation.create/execute
#     POST /v1/commands/reservation.modify/execute
#     POST /v1/commands/reservation.cancel/execute
#     POST /v1/commands/reservation.check_in/execute
#     POST /v1/commands/reservation.check_out/execute
#     POST /v1/commands/reservation.assign_room/execute
#     POST /v1/commands/reservation.unassign_room/execute
#     POST /v1/commands/reservation.extend_stay/execute
#     POST /v1/commands/reservation.rate_override/execute
#     POST /v1/commands/reservation.add_deposit/execute
#     POST /v1/commands/reservation.release_deposit/execute
#
# REST-STYLE COMMAND DISPATCH (alternative pattern):
#   POST /v1/tenants/:tenantId/reservations/:reservationId/cancel
#   POST /v1/tenants/:tenantId/reservations/:reservationId/check-in
#   POST /v1/tenants/:tenantId/reservations/:reservationId/check-out
#   POST /v1/tenants/:tenantId/reservations/:reservationId/assign-room
#   POST /v1/tenants/:tenantId/reservations/:reservationId/unassign-room
#   POST /v1/tenants/:tenantId/reservations/:reservationId/extend
#   POST /v1/tenants/:tenantId/reservations/:reservationId/rate-override
#   POST /v1/tenants/:tenantId/reservations/:reservationId/deposit/add
#   POST /v1/tenants/:tenantId/reservations/:reservationId/deposit/release
#   POST /v1/tenants/:tenantId/reservations/:reservationId/no-show
#   POST /v1/tenants/:tenantId/reservations/walk-in
#   POST /v1/tenants/:tenantId/reservations/waitlist
#   POST /v1/tenants/:tenantId/reservations/waitlist/:waitlistId/convert
#
# SAMPLE IDs:
#   Tenant:    11111111-1111-1111-1111-111111111111
#   Property:  22222222-2222-2222-2222-222222222222
#   Room Type: 44444444-4444-4444-4444-444444444444
#   Room 101:  55555555-5555-5555-5555-555555555551
#
###############################################################################
