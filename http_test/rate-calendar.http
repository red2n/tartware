###############################################################################
# RATE CALENDAR - Day-Level Rate Pricing Grid
# Routes via API Gateway (localhost:8080) -> rooms-service (port 3015)
#
# Content: Rate Calendar CRUD, Bulk Upsert, Range Fill
#
# Related files:
# - rates.http         - Rate plans (parent rate definitions)
# - rooms.http         - Room types
# - revenue.http       - Revenue management (pricing rules, demand calendar)
###############################################################################

# --- VARIABLES ---
@baseUrl = http://localhost:8080
@tenantId = 11111111-1111-1111-1111-111111111111
@propertyId = 22222222-2222-2222-2222-222222222222
@roomTypeId = 44444444-4444-4444-4444-444444444444

###############################################################################
# 1. LOGIN
###############################################################################

# @name login
POST {{baseUrl}}/v1/auth/login
Content-Type: application/json

{
  "username": "setup.admin",
  "password": "TempPass123"
}

### Extract token
@authToken = {{login.response.body.access_token}}

###############################################################################
# 2. GET RATE IDS (needed for calendar entries)
###############################################################################

# @name listRates
# List active rates to get a rate_id for calendar operations
GET {{baseUrl}}/v1/rates?tenant_id={{tenantId}}&property_id={{propertyId}}&status=ACTIVE
Authorization: Bearer {{authToken}}

### Extract first rate ID
@rateId = {{listRates.response.body.$[0].id}}

###############################################################################
# 3. RATE CALENDAR - READ
###############################################################################

# List rate calendar for a 14-day window
GET {{baseUrl}}/v1/rate-calendar?tenant_id={{tenantId}}&property_id={{propertyId}}&start_date=2026-03-01&end_date=2026-03-14
Authorization: Bearer {{authToken}}

###
# Filter by room type
GET {{baseUrl}}/v1/rate-calendar?tenant_id={{tenantId}}&property_id={{propertyId}}&start_date=2026-03-01&end_date=2026-03-14&room_type_id={{roomTypeId}}
Authorization: Bearer {{authToken}}

###
# Filter by specific rate
GET {{baseUrl}}/v1/rate-calendar?tenant_id={{tenantId}}&property_id={{propertyId}}&start_date=2026-03-01&end_date=2026-03-14&rate_id={{rateId}}
Authorization: Bearer {{authToken}}

###
# Filter by status (OPEN entries only)
GET {{baseUrl}}/v1/rate-calendar?tenant_id={{tenantId}}&property_id={{propertyId}}&start_date=2026-03-01&end_date=2026-03-14&status=OPEN
Authorization: Bearer {{authToken}}

###
# Filter by status (CLOSED entries only)
GET {{baseUrl}}/v1/rate-calendar?tenant_id={{tenantId}}&property_id={{propertyId}}&start_date=2026-03-01&end_date=2026-03-14&status=CLOSED
Authorization: Bearer {{authToken}}

###
# 7-day window (week view)
GET {{baseUrl}}/v1/rate-calendar?tenant_id={{tenantId}}&property_id={{propertyId}}&start_date=2026-03-01&end_date=2026-03-07
Authorization: Bearer {{authToken}}

###
# 30-day window (month view)
GET {{baseUrl}}/v1/rate-calendar?tenant_id={{tenantId}}&property_id={{propertyId}}&start_date=2026-03-01&end_date=2026-03-31
Authorization: Bearer {{authToken}}

###############################################################################
# 4. RATE CALENDAR - BULK UPSERT (individual days)
###############################################################################

# Upsert individual day rates (e.g., weekend premium pricing)
PUT {{baseUrl}}/v1/rate-calendar
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}",
  "property_id": "{{propertyId}}",
  "room_type_id": "{{roomTypeId}}",
  "rate_id": "{{rateId}}",
  "currency": "USD",
  "days": [
    {
      "stay_date": "2026-03-07",
      "rate_amount": 189.00,
      "status": "OPEN"
    },
    {
      "stay_date": "2026-03-08",
      "rate_amount": 189.00,
      "status": "OPEN"
    },
    {
      "stay_date": "2026-03-09",
      "rate_amount": 149.00,
      "status": "OPEN"
    }
  ]
}

###
# Upsert with CTA/CTD restrictions (close to arrival on a specific date)
PUT {{baseUrl}}/v1/rate-calendar
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}",
  "property_id": "{{propertyId}}",
  "room_type_id": "{{roomTypeId}}",
  "rate_id": "{{rateId}}",
  "currency": "USD",
  "days": [
    {
      "stay_date": "2026-03-15",
      "rate_amount": 199.00,
      "status": "OPEN",
      "closed_to_arrival": true,
      "closed_to_departure": false
    }
  ]
}

###
# Upsert with min length of stay
PUT {{baseUrl}}/v1/rate-calendar
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}",
  "property_id": "{{propertyId}}",
  "room_type_id": "{{roomTypeId}}",
  "rate_id": "{{rateId}}",
  "currency": "USD",
  "days": [
    {
      "stay_date": "2026-03-20",
      "rate_amount": 219.00,
      "status": "OPEN",
      "min_length_of_stay": 2
    },
    {
      "stay_date": "2026-03-21",
      "rate_amount": 219.00,
      "status": "OPEN",
      "min_length_of_stay": 2
    }
  ]
}

###
# Close specific dates (stop sell)
PUT {{baseUrl}}/v1/rate-calendar
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}",
  "property_id": "{{propertyId}}",
  "room_type_id": "{{roomTypeId}}",
  "rate_id": "{{rateId}}",
  "currency": "USD",
  "days": [
    {
      "stay_date": "2026-03-25",
      "rate_amount": 0,
      "status": "STOP_SELL"
    }
  ]
}

###############################################################################
# 5. RATE CALENDAR - RANGE FILL (uniform rate across date range)
###############################################################################

# Fill a week with a flat rate
POST {{baseUrl}}/v1/rate-calendar/range-fill
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}",
  "property_id": "{{propertyId}}",
  "room_type_id": "{{roomTypeId}}",
  "rate_id": "{{rateId}}",
  "currency": "USD",
  "start_date": "2026-04-01",
  "end_date": "2026-04-07",
  "rate_amount": 159.00,
  "status": "OPEN"
}

###
# Fill a month with seasonal pricing
POST {{baseUrl}}/v1/rate-calendar/range-fill
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}",
  "property_id": "{{propertyId}}",
  "room_type_id": "{{roomTypeId}}",
  "rate_id": "{{rateId}}",
  "currency": "USD",
  "start_date": "2026-06-01",
  "end_date": "2026-06-30",
  "rate_amount": 249.00,
  "status": "OPEN"
}

###
# Close a date range (e.g., renovation period)
POST {{baseUrl}}/v1/rate-calendar/range-fill
Content-Type: application/json
Authorization: Bearer {{authToken}}

{
  "tenant_id": "{{tenantId}}",
  "property_id": "{{propertyId}}",
  "room_type_id": "{{roomTypeId}}",
  "rate_id": "{{rateId}}",
  "currency": "USD",
  "start_date": "2026-05-10",
  "end_date": "2026-05-15",
  "rate_amount": 0,
  "status": "CLOSED"
}

###############################################################################
# 6. VERIFY - Read back updated calendar data
###############################################################################

# Verify bulk upsert results (March)
GET {{baseUrl}}/v1/rate-calendar?tenant_id={{tenantId}}&property_id={{propertyId}}&start_date=2026-03-01&end_date=2026-03-31
Authorization: Bearer {{authToken}}

###
# Verify range fill results (April)
GET {{baseUrl}}/v1/rate-calendar?tenant_id={{tenantId}}&property_id={{propertyId}}&start_date=2026-04-01&end_date=2026-04-07
Authorization: Bearer {{authToken}}

###
# Verify seasonal pricing (June)
GET {{baseUrl}}/v1/rate-calendar?tenant_id={{tenantId}}&property_id={{propertyId}}&start_date=2026-06-01&end_date=2026-06-30
Authorization: Bearer {{authToken}}
