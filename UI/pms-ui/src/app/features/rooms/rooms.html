<div class="rooms-page">
  <div class="page-header">
    <h1 class="page-title">Rooms</h1>
    <div class="page-actions">
      <button class="btn btn-primary btn-sm" (click)="openCreateDialog()">
        <mat-icon>add</mat-icon>
        New room
      </button>
      <button class="btn btn-invisible" (click)="loadRooms()" matTooltip="Refresh" aria-label="Refresh rooms">
        <mat-icon>refresh</mat-icon>
      </button>
    </div>
  </div>

  <!-- Filter tabs + search -->
  <div class="filter-bar">
    <nav class="filter-tabs" aria-label="Room status filters">
      @for (f of statusFilters; track f.key) {
        <button
          class="filter-tab"
          [attr.aria-pressed]="activeFilter() === f.key"
          [class.filter-tab-active]="activeFilter() === f.key"
          (click)="setFilter(f.key)">
          {{ f.label }}
          <span class="counter">{{ filterCounts()[f.key] }}</span>
        </button>
      }
    </nav>

    <div class="search-box">
      <mat-icon class="search-icon">search</mat-icon>
      <input
        type="text"
        class="search-input"
        placeholder="Search rooms..."
        aria-label="Search rooms"
        [ngModel]="searchQuery()"
        (ngModelChange)="onSearch($event)" />
    </div>
  </div>

  <!-- ═════════════════════════════════════════════ -->
  <!-- ROOM RECOMMENDATIONS                         -->
  <!-- ═════════════════════════════════════════════ -->
  <div class="rec-bar">
    <mat-icon class="rec-icon">auto_awesome</mat-icon>
    <span class="rec-label">Recommendations</span>
    <label class="rec-field">
      <span class="rec-field-label">Check-in</span>
      <input type="date" class="rec-date-input"
             [ngModel]="checkInDate()"
             (ngModelChange)="onCheckInDate($event)" />
    </label>
    <mat-icon class="rec-arrow">arrow_forward</mat-icon>
    <label class="rec-field">
      <span class="rec-field-label">Check-out</span>
      <input type="date" class="rec-date-input"
             [ngModel]="checkOutDate()"
             (ngModelChange)="onCheckOutDate($event)" />
    </label>
    @if (hasRecommendations()) {
      <span class="rec-active-badge">
        <mat-icon>check_circle</mat-icon>
        Active
      </span>
    }
    @if (checkInDate() || checkOutDate()) {
      <button class="btn btn-invisible btn-sm rec-clear-btn" (click)="clearRecommendations()" matTooltip="Clear">
        <mat-icon>close</mat-icon>
      </button>
    }
  </div>

  <!-- Content -->
  @if (loading()) {
    <div class="loading-state">
      <mat-spinner diameter="32"></mat-spinner>
      <span class="text-muted">Loading rooms...</span>
    </div>
  } @else if (error(); as err) {
    <div class="error-state">
      <mat-icon class="error-icon">error_outline</mat-icon>
      <span>{{ err }}</span>
      <button class="btn btn-outline" (click)="loadRooms()">Retry</button>
    </div>
  } @else if (filteredRooms().length === 0) {
    <div class="empty-state">
      <mat-icon class="empty-icon">hotel</mat-icon>
      @if (rooms().length === 0) {
        <p>No rooms found</p>
        <p class="text-muted">Rooms will appear here once they are configured.</p>
      } @else {
        <p>No rooms match the current filters</p>
        <button class="btn btn-outline" (click)="setFilter('ALL'); onSearch('')">Clear filters</button>
      }
    </div>
  } @else {
    <!-- Defer the heavy table rendering until idle -->
    @defer (on idle) {
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              @if (hasRecommendations()) {
                <th [attr.aria-sort]="ariaSort('recommendation_rank')">
                  <button type="button" class="th-sort-btn" (click)="onSort('recommendation_rank')">Rank <mat-icon class="sort-indicator">{{ sortIcon('recommendation_rank') }}</mat-icon></button>
                </th>
              }
              <th [attr.aria-sort]="ariaSort('room_number')">
                <button type="button" class="th-sort-btn" (click)="onSort('room_number')">Room <mat-icon class="sort-indicator">{{ sortIcon('room_number') }}</mat-icon></button>
              </th>
              <th [attr.aria-sort]="ariaSort('room_type_name')">
                <button type="button" class="th-sort-btn" (click)="onSort('room_type_name')">Type <mat-icon class="sort-indicator">{{ sortIcon('room_type_name') }}</mat-icon></button>
              </th>
              <th [attr.aria-sort]="ariaSort('floor')">
                <button type="button" class="th-sort-btn" (click)="onSort('floor')">Floor <mat-icon class="sort-indicator">{{ sortIcon('floor') }}</mat-icon></button>
              </th>
              @if (activeFilter() === 'ALL') {
                <th [attr.aria-sort]="ariaSort('status')">
                  <button type="button" class="th-sort-btn" (click)="onSort('status')">Status <mat-icon class="sort-indicator">{{ sortIcon('status') }}</mat-icon></button>
                </th>
              }
              @if (hasRecommendations()) {
                <th [attr.aria-sort]="ariaSort('recommendation_score')">
                  <button type="button" class="th-sort-btn" (click)="onSort('recommendation_score')">Score <mat-icon class="sort-indicator">{{ sortIcon('recommendation_score') }}</mat-icon></button>
                </th>
              }
              <th>Amenities</th>
              <th [attr.aria-sort]="ariaSort('housekeeping_status')">
                <button type="button" class="th-sort-btn" (click)="onSort('housekeeping_status')">Housekeeping <mat-icon class="sort-indicator">{{ sortIcon('housekeeping_status') }}</mat-icon></button>
              </th>
              <th>Maintenance</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            @for (room of paginatedRooms(); track room.room_id) {
              <tr class="row-clickable" tabindex="0" (click)="viewRoom(room.room_id)" (keydown.enter)="viewRoom(room.room_id)" (keydown.space)="$event.preventDefault(); viewRoom(room.room_id)">
                @if (hasRecommendations()) {
                  <td class="cell-rank">
                    @if (room.recommendation_rank != null) {
                      <span class="rank-badge" [matTooltip]="(room.recommendation_reasons ?? []).join(', ')">
                        #{{ room.recommendation_rank }}
                      </span>
                    } @else {
                      <span class="text-muted">—</span>
                    }
                  </td>
                }
                <td class="cell-primary">
                  <span class="room-number">{{ room.room_number }}</span>
                  @if (room.room_name) {
                    <span class="room-name text-muted">{{ room.room_name }}</span>
                  }
                </td>
                <td>{{ room.room_type_name ?? '—' }}</td>
                <td>{{ room.floor ?? '—' }}</td>
                @if (activeFilter() === 'ALL') {
                  <td>
                    <span class="badge" [ngClass]="statusClass(room.status)"
                          [matTooltip]="room.is_out_of_order ? (room.out_of_order_reason ?? '') : ''">
                      {{ room.status_display }}
                    </span>
                    @if (room.is_blocked) {
                      <span class="badge badge-warning" [matTooltip]="room.block_reason ?? ''">Blocked</span>
                    }
                    @if (room.is_out_of_order && room.status !== 'out_of_order') {
                      <span class="badge badge-danger" [matTooltip]="room.out_of_order_reason ?? ''">OOO</span>
                    }
                  </td>
                }
                @if (hasRecommendations()) {
                  <td class="cell-score">
                    @if (room.recommendation_score != null) {
                      <div class="score-bar" [matTooltip]="scorePercent(room.recommendation_score) + '% match'">
                        <div class="score-fill" [ngClass]="scoreClass(room.recommendation_score)"
                             [style.width.%]="scorePercent(room.recommendation_score)"></div>
                      </div>
                      <span class="score-value">{{ scorePercent(room.recommendation_score) }}%</span>
                    } @else {
                      <span class="text-muted">—</span>
                    }
                  </td>
                }
                <td class="cell-amenities">
                  @if (roomAmenities(room).length > 0) {
                    @for (a of roomAmenities(room).slice(0, 3); track a) {
                      <span class="tag tag-compact">{{ amenityLabel(a) }}</span>
                    }
                    @if (roomAmenities(room).length > 3) {
                      <span class="tag tag-compact tag-more"
                            [matTooltip]="roomAmenities(room).slice(3).map(amenityLabel).join(', ')">
                        +{{ roomAmenities(room).length - 3 }}
                      </span>
                    }
                  } @else {
                    <span class="text-muted">—</span>
                  }
                </td>
                <td>
                  <span class="badge" [ngClass]="hkClass(room.housekeeping_status)">
                    {{ room.housekeeping_display }}
                  </span>
                </td>
                <td>{{ room.maintenance_display }}</td>
                <td class="cell-actions">
                  <a class="btn btn-invisible btn-sm" [routerLink]="['/rooms', room.room_id]" matTooltip="View details" aria-label="View room details">
                    <mat-icon>chevron_right</mat-icon>
                  </a>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
      <app-pagination
        [totalItems]="filteredRooms().length"
        [currentPage]="currentPage()"
        [pageSize]="pageSize"
        (pageChange)="currentPage.set($event)" />
    } @placeholder {
      <div class="placeholder-table">
        <div class="placeholder-row"></div>
        <div class="placeholder-row"></div>
        <div class="placeholder-row"></div>
        <div class="placeholder-row"></div>
        <div class="placeholder-row"></div>
      </div>
    } @loading (minimum 200ms) {
      <div class="loading-state">
        <mat-spinner diameter="24"></mat-spinner>
        <span class="text-muted">Rendering table...</span>
      </div>
    }
  }
</div>
