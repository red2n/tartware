<div class="reservations-page">
  <div class="page-header">
    <h1 class="page-title">Reservations</h1>
    <div class="page-actions">
      <button class="btn btn-primary btn-sm" (click)="openCreateReservation()">
        <mat-icon>add</mat-icon>
        New reservation
      </button>
      <button class="btn btn-invisible" (click)="loadReservations()" matTooltip="Refresh">
        <mat-icon>refresh</mat-icon>
      </button>
    </div>
  </div>

  <!-- Filter tabs + search -->
  <div class="filter-bar">
    <nav class="filter-tabs">
      @for (f of statusFilters; track f.key) {
        <button
          class="filter-tab"
          [class.filter-tab-active]="activeFilter() === f.key"
          (click)="setFilter(f.key)">
          {{ f.label }}
          <span class="counter">{{ filterCounts()[f.key] }}</span>
        </button>
      }
    </nav>

    <div class="search-box">
      <mat-icon class="search-icon">search</mat-icon>
      <input
        type="text"
        class="search-input"
        placeholder="Search reservations..."
        [ngModel]="searchQuery()"
        (ngModelChange)="onSearch($event)" />
    </div>
  </div>

  <!-- Content -->
  @if (loading()) {
    <div class="loading-state">
      <mat-spinner diameter="32"></mat-spinner>
      <span class="text-muted">Loading reservations...</span>
    </div>
  } @else if (error(); as err) {
    <div class="error-state">
      <mat-icon class="error-icon">error_outline</mat-icon>
      <span>{{ err }}</span>
      <button class="btn btn-outline" (click)="loadReservations()">Retry</button>
    </div>
  } @else if (filteredReservations().length === 0) {
    <div class="empty-state">
      <mat-icon class="empty-icon">book_online</mat-icon>
      @if (reservations().length === 0) {
        <p>No reservations found</p>
        <p class="text-muted">Reservations will appear here once they are created.</p>
        <button class="btn btn-primary" (click)="openCreateReservation()">Create first reservation</button>
      } @else {
        <p>No reservations match the current filters</p>
        <button class="btn btn-outline" (click)="setFilter('ALL'); onSearch('')">Clear filters</button>
      }
    </div>
  } @else {
    @defer (on idle) {
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Confirmation</th>
              <th>Guest</th>
              <th>Room Type</th>
              <th>Check-in</th>
              <th>Check-out</th>
              <th>Nights</th>
              @if (activeFilter() === 'ALL') {
                <th>Status</th>
              }
              <th>Amount</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            @for (res of filteredReservations(); track res.id) {
              <tr class="row-clickable" (click)="viewReservation(res.id)">
                <td class="cell-primary">
                  <span class="confirmation-number">{{ res.confirmation_number }}</span>
                  @if (res.source) {
                    <span class="text-subtle">{{ res.source }}</span>
                  }
                </td>
                <td>
                  <div class="guest-cell">
                    <span class="guest-name">{{ res.guest_name }}</span>
                    <span class="text-subtle">{{ res.guest_email }}</span>
                  </div>
                </td>
                <td>{{ res.room_type_name ?? 'â€”' }}</td>
                <td>{{ formatDate(res.check_in_date) }}</td>
                <td>{{ formatDate(res.check_out_date) }}</td>
                <td class="text-center">{{ res.nights }}</td>
                @if (activeFilter() === 'ALL') {
                  <td>
                    <span class="badge" [ngClass]="statusClass(res.status)">
                      {{ res.status_display }}
                    </span>
                  </td>
                }
                <td class="cell-amount">{{ formatCurrency(res.total_amount, res.currency) }}</td>
                <td class="cell-actions">
                  <button class="btn btn-invisible btn-sm" matTooltip="View details">
                    <mat-icon>chevron_right</mat-icon>
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    } @placeholder {
      <div class="placeholder-table">
        <div class="placeholder-row"></div>
        <div class="placeholder-row"></div>
        <div class="placeholder-row"></div>
        <div class="placeholder-row"></div>
        <div class="placeholder-row"></div>
      </div>
    } @loading (minimum 200ms) {
      <div class="loading-state">
        <mat-spinner diameter="24"></mat-spinner>
        <span class="text-muted">Rendering table...</span>
      </div>
    }
  }
</div>
