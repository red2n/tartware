<header class="header">
  <div class="header-left">
    <button class="header-btn menu-toggle" (click)="menuToggle.emit()">
      <mat-icon>menu</mat-icon>
    </button>

    <!-- Tenant switcher (only if user has multiple tenant memberships) -->
    @if (showTenantSwitcher) {
      <button class="context-btn" [matMenuTriggerFor]="tenantMenu" matTooltip="Switch tenant">
        <mat-icon class="context-icon">business</mat-icon>
        <span class="context-label">{{ activeMembership()?.tenant_name ?? 'No tenant' }}</span>
        <mat-icon class="context-caret">arrow_drop_down</mat-icon>
      </button>
      <mat-menu #tenantMenu="matMenu">
        @for (m of memberships(); track m.tenant_id) {
          <button mat-menu-item
            [class.active-menu-item]="m.tenant_id === activeMembership()?.tenant_id"
            (click)="switchTenant(m.tenant_id)">
            <mat-icon>{{ m.tenant_id === activeMembership()?.tenant_id ? 'check' : 'business' }}</mat-icon>
            <span>{{ m.tenant_name ?? m.tenant_id }}</span>
          </button>
        }
      </mat-menu>
    } @else if (activeMembership(); as m) {
      <span class="context-label-static" matTooltip="Tenant">
        <mat-icon class="context-icon">business</mat-icon>
        {{ m.tenant_name ?? 'Tenant' }}
      </span>
    }

    <!-- Property selector -->
    @if (properties().length > 1) {
      <span class="context-divider"></span>
      <button class="context-btn" [matMenuTriggerFor]="propertyMenu" matTooltip="Switch property">
        <mat-icon class="context-icon">apartment</mat-icon>
        <span class="context-label">{{ activeProperty()?.property_name ?? 'All properties' }}</span>
        <mat-icon class="context-caret">arrow_drop_down</mat-icon>
      </button>
      <mat-menu #propertyMenu="matMenu">
        @for (p of properties(); track p.id) {
          <button mat-menu-item
            [class.active-menu-item]="p.id === activeProperty()?.id"
            (click)="selectProperty(p.id)">
            <mat-icon>{{ p.id === activeProperty()?.id ? 'check' : 'apartment' }}</mat-icon>
            <div class="property-menu-item">
              <span>{{ p.property_name }}</span>
              <span class="property-code">{{ p.property_code }}</span>
            </div>
          </button>
        }
      </mat-menu>
    } @else if (activeProperty(); as p) {
      <span class="context-divider"></span>
      <span class="context-label-static" matTooltip="Property">
        <mat-icon class="context-icon">apartment</mat-icon>
        {{ p.property_name }}
      </span>
    }
  </div>

  <span class="spacer"></span>

  <div class="header-right">
    <!-- Theme toggle -->
    <button class="header-btn" [matMenuTriggerFor]="themeMenu" matTooltip="Theme">
      <mat-icon>{{ isDark() ? 'dark_mode' : 'light_mode' }}</mat-icon>
    </button>

    <mat-menu #themeMenu="matMenu" class="theme-menu">
      <button mat-menu-item (click)="setTheme('LIGHT')">
        <mat-icon>light_mode</mat-icon>
        <span>Light</span>
        @if (themeMode() === 'LIGHT') {
          <mat-icon class="check-icon">check</mat-icon>
        }
      </button>
      <button mat-menu-item (click)="setTheme('DARK')">
        <mat-icon>dark_mode</mat-icon>
        <span>Dark</span>
        @if (themeMode() === 'DARK') {
          <mat-icon class="check-icon">check</mat-icon>
        }
      </button>
      <button mat-menu-item (click)="setTheme('SYSTEM')">
        <mat-icon>computer</mat-icon>
        <span>System</span>
        @if (themeMode() === 'SYSTEM') {
          <mat-icon class="check-icon">check</mat-icon>
        }
      </button>
    </mat-menu>

    <!-- User menu -->
    <button class="header-btn avatar-btn" [matMenuTriggerFor]="userMenu">
      @if (user(); as u) {
        <span class="avatar avatar-md user-avatar">
          {{ u.first_name.charAt(0) }}{{ u.last_name.charAt(0) }}
        </span>
      } @else {
        <mat-icon>account_circle</mat-icon>
      }
    </button>

    <mat-menu #userMenu="matMenu">
      @if (user(); as u) {
        <div class="user-menu-header" mat-menu-item disabled>
          <span class="avatar avatar-md user-avatar">{{ u.first_name.charAt(0) }}{{ u.last_name.charAt(0) }}</span>
          <div class="user-menu-info">
            <strong>{{ u.first_name }} {{ u.last_name }}</strong>
            <span class="text-muted">{{ u.username }}</span>
          </div>
        </div>
      }
      <mat-divider></mat-divider>
      <button mat-menu-item (click)="logout()">
        <mat-icon>logout</mat-icon>
        <span>Sign out</span>
      </button>
    </mat-menu>
  </div>
</header>
